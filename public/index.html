<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Exlify</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="icon" type="image/png" href="logo.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#10b981">

  <!-- Chromecast SDK -->
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log('Service Worker registrado'))
        .catch(console.error);
    }
  </script>

  <style>
    :root {
      --sp-green: #1ed760;
      --sp-green-light: #1fdf64;
      --sp-black: #000000;
      --sp-dark-gray: #121212;
      --sp-card-bg: #181818;
      --sp-card-hover: #282828;
      --sp-light-gray: #b3b3b3;
      --sp-white: #ffffff;
      --player-height: 90px;
      --nav-height: 65px;
      --font-stack: 'Circular Std', -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif;
      --safe-area-bottom: env(safe-area-inset-bottom);
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      background: var(--sp-black);
      color: var(--sp-white);
      font-family: var(--font-stack);
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
      user-select: none;
    }

    /* --- UTILITÁRIOS --- */
    .hidden { display: none !important; }
    .flex { display: flex; }
    .flex-col { display: flex; flex-direction: column; }
    .center { display: flex; align-items: center; justify-content: center; }
    .text-truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .pointer { cursor: pointer; }
    .text-green { color: var(--sp-green) !important; }

    /* ANIMAÇÕES FLUIDAS */
    .fade-in { animation: fadeIn 0.4s ease forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* SKELETON LOADING (SHIMMER) */
    .skeleton {
        background: #2a2a2a;
        background-image: linear-gradient(to right, #2a2a2a 0%, #3a3a3a 20%, #2a2a2a 40%, #2a2a2a 100%);
        background-repeat: no-repeat;
        background-size: 800px 100%; 
        animation: shimmer 1.5s infinite linear forwards;
        border-radius: 4px;
        color: transparent !important;
    }
    @keyframes shimmer { 0% { background-position: -400px 0; } 100% { background-position: 400px 0; } }

    /* TOAST NOTIFICATION */
    #toast-container {
        position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
        z-index: 5000; pointer-events: none; width: auto; max-width: 90%;
    }
    .toast {
        background: #2e77d0; color: #fff; padding: 12px 24px; border-radius: 4px;
        margin-bottom: 10px; font-size: 14px; font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s, transform 0.3s;
        transform: translateY(20px); text-align: center;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.error { background: #e91429; }
    .toast.success { background: #1ed760; color: #000; }
    .toast.offline { background: #555; color: #fff; border: 1px solid #777; }

    /* --- LAYOUT PRINCIPAL --- */
    #main-wrapper { 
        display: flex; 
        flex: 1; 
        overflow: hidden; 
        position: relative; 
        width: 100%;
        gap: 8px; /* Espaço estilo Spotify Web */
        padding: 8px;
    }

    /* Sidebar (Desktop) */
    #sidebar {
      width: 280px; /* Largura padrão */
      min-width: 240px;
      display: flex; flex-direction: column;
      gap: 8px;
      height: 100%;
      flex-shrink: 0;
    }

    .sidebar-block {
        background: var(--sp-dark-gray); border-radius: 8px;
        padding: 16px 24px; display: flex; flex-direction: column;
        transition: background 0.3s ease;
    }

    .logo { 
        padding-bottom: 20px; font-size: 24px; font-weight: 700; 
        display: flex; align-items: center; gap: 10px; color: #fff; letter-spacing: -1px;
    }
    .logo img { height: 32px; width: auto; object-fit: contain; }
    
    .nav-btn {
      display: flex; align-items: center; gap: 20px; padding: 10px 0;
      color: var(--sp-light-gray); font-weight: 700; cursor: pointer; transition: color 0.2s ease; font-size: 16px;
    }
    .nav-btn:hover { color: var(--sp-white); }
    .nav-btn.active { color: var(--sp-white); }
    .nav-btn i { font-size: 22px; width: 24px; display: flex; justify-content: center; }
    
    .library-header {
        display: flex; justify-content: space-between; align-items: center;
        color: var(--sp-light-gray); font-weight: 700; margin-bottom: 12px;
        padding-left: 8px;
    }
    .library-header span { display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; }
    .library-header span:hover { color: #fff; }
    .library-header i { transition: all 0.2s ease; }
    .library-header i:hover { color: #fff; transform: scale(1.1); background: #2a2a2a; border-radius: 50%; }
    .library-header .fa-plus, .library-header .fa-download { padding: 8px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }

    .library-scroll {
      flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 2px;
      margin-top: 5px; min-height: 0; height: 100%; padding-bottom: 20px; 
    }
    
    .playlist-item {
      padding: 8px; font-size: 14px; color: #b3b3b3; cursor: pointer; border-radius: 6px;
      display: flex; align-items: center; gap: 12px; transition: background 0.2s ease;
    }
    .playlist-item img { width: 48px; height: 48px; border-radius: 4px; background: #333; object-fit: cover; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
    .playlist-item:hover { background: #1a1a1a; color: #fff; }
    .playlist-item.active-pl { background: #232323; color: #fff; }
    .pl-info-side { overflow: hidden; flex: 1; }
    .pl-info-side h4 { margin: 0; font-weight: 400; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 15px; }
    .pl-info-side p { margin: 0; font-size: 13px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Conteúdo Central */
    #content {
      flex: 1;
      background: linear-gradient(180deg, #202020 0%, #121212 300px);
      overflow-y: auto; 
      border-radius: 8px;
      padding: 0 24px;
      position: relative;
      padding-bottom: 40px; 
      transition: background 0.5s ease; /* Transição suave de cor */
    }
    
    /* HEADER TRANSPARENTE / STICKY */
    .top-bar {
        display: flex; justify-content: space-between; align-items: center;
        position: sticky; top: 0; z-index: 40;
        height: 64px; margin: 0 -24px 20px -24px; padding: 0 24px;
        background-color: rgba(18, 18, 18, 0); 
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    .top-bar.scrolled { background-color: rgba(18, 18, 18, 1); box-shadow: 0 4px 20px rgba(0,0,0,0.4); }

    .top-bar-nav { display: flex; gap: 8px; }
    .back-btn { 
        width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.7); 
        display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; 
        border: none; transition: all 0.2s ease;
    }
    .back-btn:hover:not(.disabled) { transform: scale(1.05); background: rgba(0,0,0,0.9); }
    .back-btn.disabled { opacity: 0.5; cursor: not-allowed; }

    .user-pill {
        background: rgba(0,0,0,0.7); padding: 2px 8px 2px 2px; border-radius: 20px;
        display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 700; font-size: 14px;
        transition: background 0.2s ease; position: relative; margin-left: auto;
    }
    .user-pill:hover { background: #282828; }
    .user-avatar { width: 28px; height: 28px; border-radius: 50%; background: #535353; display: flex; center; justify-content: center; align-items: center; overflow: hidden;}
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    
    .user-menu-dropdown {
        position: absolute; top: 45px; right: 0; background: #282828; 
        border-radius: 4px; padding: 4px; width: 180px; box-shadow: 0 16px 24px rgba(0,0,0,0.5);
        display: none; flex-direction: column; z-index: 100;
    }
    .user-menu-dropdown.active { display: flex; animation: fadeIn 0.2s ease; }
    .um-item { padding: 10px 12px; font-size: 13px; color: #eee; cursor: pointer; text-align: left; border-radius: 2px; }
    .um-item:hover { background: #3e3e3e; }

    /* CTA LOGIN CARD */
    .login-cta {
        background: linear-gradient(90deg, #af2896, #509bf5);
        border-radius: 8px; padding: 16px 24px; margin-bottom: 24px;
        display: flex; justify-content: space-between; align-items: center;
        animation: fadeIn 0.5s ease;
    }
    .login-cta h3 { margin: 0; font-size: 18px; }
    .login-cta p { margin: 4px 0 0; font-size: 13px; opacity: 0.9; }
    .login-btn-white {
        background: #fff; color: #000; border: none; padding: 12px 32px;
        border-radius: 50px; font-weight: 700; cursor: pointer; font-size: 15px;
        transform: scale(1); transition: transform 0.1s ease; margin-left: auto;
    }
    .login-btn-white:hover { transform: scale(1.04); background: #f2f2f2; }
    .login-btn-white:active { transform: scale(0.98); }

    /* --- SCROLLBAR DISFARÇADA --- */
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.2); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
    ::-webkit-scrollbar-thumb:hover { background-color: rgba(255,255,255,0.4); }

    /* --- VIEWS --- */
    .view { display: none; opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease; }
    .view.active { display: block; opacity: 1; transform: translateY(0); }
    
    h2 { font-size: 24px; margin-bottom: 20px; font-weight: 700; letter-spacing: -0.5px; }
    h3 { font-size: 20px; margin-bottom: 16px; font-weight: 700; }

    /* SEÇÃO DE GÊNEROS */
    .genre-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 24px;
        margin-bottom: 40px;
    }
    .genre-card {
        height: 180px;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.3s ease;
    }
    .genre-card:hover { transform: scale(1.02); }
    .genre-title {
        font-size: 24px; font-weight: 700; padding: 20px;
        position: absolute; top: 0; left: 0; width: 100%; word-break: break-word;
    }
    .genre-img {
        position: absolute; bottom: 0; right: 0;
        width: 100px; height: 100px;
        transform: rotate(25deg) translate(18%, -2%);
        box-shadow: -2px 2px 10px rgba(0,0,0,0.3);
        display: flex; align-items: center; justify-content: center;
        background: rgba(0,0,0,0.2);
    }
    .genre-img i { font-size: 50px; }


    /* GRID DE CARDS */
    .grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
        gap: 24px; 
    }
    
    .card {
      background: var(--sp-card-bg); padding: 16px; border-radius: 8px;
      transition: background 0.3s ease; cursor: pointer; position: relative;
      display: flex; flex-direction: column; overflow: hidden; isolation: isolate;
    }
    .card:hover { background: var(--sp-card-hover); }
    .card img { 
        width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 4px; margin-bottom: 16px; 
        box-shadow: 0 8px 24px rgba(0,0,0,0.5); 
    }
    .card-title { font-weight: 700; margin-bottom: 8px; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff; }
    .card-desc { color: var(--sp-light-gray); font-size: 13px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5; font-weight: 400; }

    .play-btn-hover {
      position: absolute; bottom: 105px; right: 24px;
      width: 48px; height: 48px; border-radius: 50%;
      background: var(--sp-green); color: #000;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; box-shadow: 0 8px 8px rgba(0,0,0,0.3);
      opacity: 0; transform: translateY(10px); transition: all 0.3s cubic-bezier(0.3, 0, 0, 1); z-index: 10;
    }
    .card:hover .play-btn-hover { opacity: 1; transform: translateY(0); }
    .play-btn-hover:hover { transform: scale(1.1) !important; background: var(--sp-green-light); }
    .play-btn-hover:active { transform: scale(0.95) !important; }

    /* LISTA DE MÚSICAS */
    .track-list-item {
      display: grid; grid-template-columns: 40px 50px 1fr 40px 60px; 
      align-items: center; padding: 8px 16px; border-radius: 4px; cursor: pointer;
      transition: background 0.2s ease; position: relative; color: #b3b3b3; font-size: 14px;
      margin: 0 -16px;
    }
    .track-list-item:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .track-list-item img { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; }
    .track-list-item:hover .track-num { display: none; }
    .track-list-item:hover .track-play-icon { display: block; }
    
    .track-num { font-size: 14px; }
    .track-play-icon { display: none; color: #fff; font-size: 14px; }
    
    .track-list-item .meta { padding-left: 12px; overflow: hidden; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
    .track-title { color: #fff; font-size: 16px; font-weight: 400; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .track-artist { font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: 0.2s; }
    .track-list-item:hover .track-artist { color: #fff; }
    .track-list-item:hover .track-title { color: #fff; }
    
    /* MOBILE LIBRARY LIST */
    .mobile-lib-item {
        display: flex; align-items: center; gap: 15px; padding: 10px 0; border-bottom: 0px solid #282828; cursor: pointer;
    }
    .mobile-lib-item:active { opacity: 0.7; }
    .mobile-lib-img { width: 56px; height: 56px; border-radius: 4px; display: flex; center; justify-content: center; background: #333; flex-shrink: 0; overflow: hidden; }
    .mobile-lib-img img { width: 100%; height: 100%; object-fit: cover; }
    .mobile-lib-info { overflow: hidden; flex: 1; }
    .mobile-lib-info h4 { margin: 0; color: #fff; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mobile-lib-info p { margin: 4px 0 0; color: #b3b3b3; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* PLAYLIST HEADER */
    .pl-header {
        display: flex; align-items: flex-end; gap: 24px; padding: 20px 0 24px;
        background: linear-gradient(transparent 0, rgba(0,0,0,0.5) 100%);
        flex-wrap: wrap; isolation: isolate;
    }
    .pl-cover-large {
        width: 232px; height: 232px; box-shadow: 0 4px 60px rgba(0,0,0,0.5);
        display: flex; align-items: center; justify-content: center; background: #282828;
        font-size: 64px; color: #7f7f7f; flex-shrink: 0;
        overflow: hidden; border-radius: 4px;
        transition: transform 0.3s ease;
    }
    .pl-cover-large:hover { transform: scale(1.02); }
    .pl-cover-large img { width: 100%; height: 100%; object-fit: cover; }
    .pl-details { flex: 1; overflow: hidden; min-width: 200px; display: flex; flex-direction: column; justify-content: flex-end; }
    .pl-type { font-size: 12px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; }
    .pl-name { font-size: clamp(32px, 6vw, 96px); font-weight: 900; margin: 0 0 12px; line-height: 1; letter-spacing: -2px; word-break: break-word; }
    .pl-meta { display: flex; align-items: center; gap: 4px; font-size: 14px; color: #fff; font-weight: 500; }

    /* SEARCH */
    .search-header { position: sticky; top: 0; z-index: 50; padding: 10px 0 20px; background: inherit; }
    .search-bar { background: #2a2a2a; border-radius: 500px; padding: 12px 20px; color: #b3b3b3; display: flex; align-items: center; width: 100%; max-width: 360px; border: 2px solid transparent; transition: all 0.2s ease; }
    .search-bar:focus-within { background: #333; border: 2px solid #fff; color: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.1); }
    .search-bar input { border: none; font-weight: 400; width: 100%; margin-left: 10px; font-size: 14px; background: transparent; color: inherit; height: 100%; }

    /* --- PLAYER BAR --- */
    #player-bar {
      position: relative; 
      bottom: auto; left: auto; right: auto;
      height: var(--player-height);
      background: #181818; 
      border-top: 1px solid #282828;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px; 
      z-index: 200;
      width: 100%;
      flex-shrink: 0;
    }
    .player-left { display: flex; align-items: center; width: 30%; min-width: 180px; }
    .player-left img { width: 56px; height: 56px; margin-right: 14px; border-radius: 4px; object-fit: cover; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .current-info { overflow: hidden; display: flex; flex-direction: column; justify-content: center; margin-right: 15px; }
    .current-info h4 { margin: 0; font-size: 14px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
    .current-info h4:hover { text-decoration: underline; }
    .current-info p { margin: 0; font-size: 11px; color: #b3b3b3; margin-top: 2px; cursor: pointer; }
    .current-info p:hover { text-decoration: underline; color: #fff; }

    .player-center { width: 40%; display: flex; flex-direction: column; align-items: center; max-width: 722px; }
    .controls { display: flex; align-items: center; gap: 20px; margin-bottom: 8px; }
    .controls i { font-size: 16px; color: #b3b3b3; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; }
    .controls i:hover { color: #fff; transform: scale(1.1); }
    .controls i:active { transform: scale(0.95); }
    .controls i.active-control { color: var(--sp-green); position: relative; }
    .controls i.active-control::after { content: '.'; position: absolute; bottom: -8px; font-size: 20px; color: var(--sp-green); }
    
    .play-icon { font-size: 16px; color: #000; background: #fff; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: 0.2s; position: relative; }
    .play-icon:hover { transform: scale(1.05); background: #f0f0f0; }
    .play-icon:active { transform: scale(0.95); }

    /* LOADING SPINNER IN PLAYER */
    .play-icon.buffering::after, .fp-play.buffering::after {
        content: ''; position: absolute; top:0; left:0; right:0; bottom:0;
        border-radius: 50%; border: 3px solid transparent;
        border-top-color: var(--sp-green); border-right-color: var(--sp-green);
        animation: spin 0.8s linear infinite;
    }
    .play-icon.buffering i, .fp-play.buffering i { opacity: 0; }
    .mobile-mini-play.buffering {
        color: transparent !important;
        position: relative;
    }
    .mobile-mini-play.buffering::after {
        content: ''; position: absolute; top: 0; left: 0;
        width: 100%; height: 100%;
        border-radius: 50%; border: 2px solid transparent;
        border-top-color: #fff; border-right-color: #fff;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .progress-container { width: 100%; display: flex; align-items: center; gap: 8px; font-size: 11px; color: #b3b3b3; font-family: monospace; }
    
    .sp-range {
      -webkit-appearance: none; width: 100%; height: 4px; background: transparent; cursor: pointer;
      position: relative; border-radius: 2px;
    }
    .sp-range:focus { outline: none; }
    
    .sp-range::-webkit-slider-runnable-track {
      width: 100%; height: 4px; border-radius: 2px;
      background: linear-gradient(90deg, #b3b3b3 var(--progress-percent, 0%), #555 var(--progress-percent, 0%) var(--buffered-percent, 0%), #4d4d4d var(--buffered-percent, 0%));
    }
    .sp-range::-webkit-slider-thumb {
      -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #fff;
      margin-top: -4px; box-shadow: 0 2px 4px rgba(0,0,0,0.5); 
      transform: scale(0); transition: transform 0.1s ease;
    }
    .progress-container:hover .sp-range::-webkit-slider-runnable-track {
        background: linear-gradient(90deg, var(--sp-green) var(--progress-percent, 0%), #555 var(--progress-percent, 0%) var(--buffered-percent, 0%), #4d4d4d var(--buffered-percent, 0%));
    }
    .progress-container:hover .sp-range::-webkit-slider-thumb { transform: scale(1); }
    .sp-range:active::-webkit-slider-thumb { transform: scale(1); }

    .player-right { width: 30%; display: flex; justify-content: flex-end; align-items: center; gap: 12px; position: relative; }
    .player-right i { color: #b3b3b3; font-size: 16px; display: flex; justify-content: center; cursor: pointer; transition: 0.2s; }
    .player-right i:hover { color: #fff; transform: scale(1.1); }
    .vol-wrapper { display: flex; align-items: center; width: 100px; }

    /* CAST BUTTON */
    .cast-btn { font-size: 16px; color: #b3b3b3; cursor: pointer; transition: 0.2s; }
    .cast-btn:hover { color: #fff; }
    .cast-btn.connected { color: var(--sp-green); }

    /* LYRICS */
    .lyrics-container {
        display: none; width: 100%; height: 100%; overflow-y: auto; text-align: center;
        padding: 20px; color: #fff; font-size: 24px; line-height: 1.6; font-weight: 700;
        mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);
        -webkit-mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);
    }
    .lyrics-container.active { display: block; animation: fadeIn 0.4s ease; }
    .lyrics-line { margin-bottom: 20px; opacity: 0.6; transition: 0.3s; }
    .lyrics-line.active { opacity: 1; transform: scale(1.05); color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.4); }
    .lyrics-btn {
        background: rgba(0,0,0,0.3); color: #b3b3b3; border: none; padding: 6px 16px; border-radius: 20px;
        font-weight: 700; font-size: 12px; cursor: pointer; transition: 0.2s;
    }
    .lyrics-btn:hover, .lyrics-btn.active { background: #fff; color: #000; }

    /* MOBILE NAV & PLAYER */
    #mobile-nav {
      display: none; position: fixed; bottom: 0; left: 0; right: 0;
      height: var(--nav-height); background: linear-gradient(180deg, rgba(18,18,18,0.9) 0%, #000 100%);
      backdrop-filter: blur(10px);
      justify-content: space-around; align-items: center; z-index: 201; border-top: 1px solid #282828;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .mobile-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #b3b3b3; cursor: pointer; padding: 5px; flex: 1; transition: color 0.2s;}
    .mobile-item i { font-size: 22px; margin-bottom: 4px; transition: 0.2s; }
    .mobile-item.active { color: #fff; }
    .mobile-item:active i { transform: scale(0.9); }

    #full-player {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #121212;
      z-index: 1000; 
      display: flex; flex-direction: column; 
      padding: 20px 24px 40px;
      transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0, 0, 1);
      overflow: hidden; /* IMPORTANTE: Remove o scroll */
      will-change: transform;
    }
    #full-player.open { transform: translateY(0); }
    
    .fp-header {
        display:flex; justify-content:space-between; align-items:center; 
        margin-bottom:10px; color:#fff; flex-shrink: 0;
    }
    
    .fp-content-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center; /* Centraliza verticalmente */
        min-height: 0; /* Permite encolher */
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
    }

    .fp-art-container {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 0;
        margin-bottom: 20px;
        width: 100%;
        position: relative;
    }

    .fp-art { 
        width: auto; 
        height: auto; 
        max-width: 100%; 
        max-height: 100%; 
        aspect-ratio: 1; 
        border-radius: 8px; 
        box-shadow: 0 10px 40px rgba(0,0,0,0.6); 
        object-fit: contain; 
        transition: opacity 0.3s;
    }
    
    .fp-controls { display: flex; flex-direction: column; gap: 15px; width: 100%; margin-top: auto; flex-shrink: 0; }
    .fp-main-btns { display: flex; align-items: center; justify-content: space-between; margin-top: 5px; }
    .fp-play { width: 64px; height: 64px; border-radius: 50%; background: #fff; color: #000; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; transition: 0.1s; position: relative; }
    .fp-play:active { transform: scale(0.95); background: #ccc; }

    /* MODALS */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); z-index: 2000;
      display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
      animation: fadeIn 0.3s ease;
    }
    .modal-box {
      background: #282828; padding: 32px; border-radius: 8px; width: 90%; max-width: 400px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5); text-align: center;
      animation: modalUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    }
    @keyframes modalUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .sp-input { width: 100%; padding: 12px; background: #3e3e3e; border: 1px solid transparent; border-radius: 4px; color: #fff; margin: 10px 0; font-size: 14px; font-weight: 500; transition: 0.2s; }
    .sp-input:focus { background: #333; outline: 1px solid #fff; border-color: #555; }
    
    .sp-btn { border: none; padding: 14px 32px; border-radius: 50px; font-weight: 700; cursor: pointer; font-size: 14px; text-transform: uppercase; transition: transform 0.1s ease, background 0.2s; margin-top: 10px; letter-spacing: 1px; }
    .sp-btn:active { transform: scale(0.98); }
    .sp-btn-primary { background: var(--sp-green); color: #000; width: 100%; }
    .sp-btn-primary:hover { transform: scale(1.02); background: var(--sp-green-light); }
    .sp-btn-google { background: #fff; color: #333; width: 100%; margin-top: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; text-transform: none; }
    .sp-btn-google:hover { background: #f1f1f1; }
    .sp-btn-sec { background: transparent; color: #b3b3b3; text-transform: none; }
    .sp-btn-sec:hover { color: #fff; }
    .sp-btn-danger { background: transparent; color: #e91429; border: 1px solid rgba(233,20,41,0.3); }
    .sp-btn-danger:hover { border: 1px solid #e91429; color: #fff; }
    .modal-link { margin-top: 15px; color: #b3b3b3; font-size: 13px; cursor: pointer; text-decoration: underline; }

    /* EDIT PROFILE IMAGE */
    .edit-profile-img-wrapper {
        width: 120px; height: 120px; border-radius: 50%;
        background: #333; margin: 0 auto 20px;
        display: flex; align-items: center; justify-content: center;
        overflow: hidden; position: relative; cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
    .edit-profile-img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
    .edit-profile-img-wrapper:hover .edit-overlay-profile { opacity: 1; }
    .edit-overlay-profile {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); display: flex;
        align-items: center; justify-content: center;
        opacity: 0; transition: 0.2s; color: #fff; font-size: 24px;
    }

    /* EDIT MODAL */
    #modal-edit-pl .modal-box { max-width: 520px; display: flex; flex-direction: column; }
    .edit-grid { display: flex; gap: 20px; align-items: flex-start; text-align: left; }
    .edit-cover-wrapper {
        width: 180px; height: 180px; background: #333; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.5); position: relative;
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0;
    }
    .edit-cover-wrapper img { width: 100%; height: 100%; object-fit: cover; }
    .edit-cover-wrapper:hover .edit-overlay { opacity: 1; }
    .edit-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); display: flex; flex-direction: column;
        align-items: center; justify-content: center; opacity: 0; transition: 0.2s;
        cursor: pointer; color: #fff; font-size: 12px; gap: 5px;
    }
    .edit-inputs { flex: 1; display: flex; flex-direction: column; gap: 10px; width: 100%; }

    /* CONTEXT MENU */
    .context-menu {
      position: absolute; background: #282828; border-radius: 4px; padding: 4px;
      box-shadow: 0 16px 24px rgba(0,0,0,0.5); z-index: 3000; min-width: 200px;
      display: none; flex-direction: column;
      animation: fadeIn 0.2s ease;
    }
    .context-menu.active { display: flex; }
    .ctx-item { padding: 12px; color: #eee; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-radius: 2px; }
    .ctx-item:hover { background: #3e3e3e; }
    
    /* MULTI SELECT LIST */
    .playlist-select-item {
        display: flex; align-items: center; gap: 12px;
        padding: 10px; border-radius: 4px;
        cursor: pointer; transition: background 0.2s;
        text-align: left;
    }
    .playlist-select-item:hover { background: #3e3e3e; }
    .playlist-select-item img { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; background: #333; }
    .playlist-select-info { flex: 1; overflow: hidden; }
    .playlist-select-name { font-size: 14px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .playlist-select-count { font-size: 12px; color: #b3b3b3; }
    .playlist-checkbox {
        width: 20px; height: 20px; border: 1px solid #b3b3b3; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        transition: 0.2s;
    }
    .playlist-select-item.selected .playlist-checkbox {
        background: var(--sp-green); border-color: var(--sp-green); color: #000;
    }
    .playlist-select-item.selected .playlist-checkbox::after {
        content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; font-size: 12px;
    }

    /* RESPONSIVIDADE */
    @media (max-width: 768px) {
      body { height: auto; display: block; overflow: auto; }
      #sidebar { display: none; }
      #mobile-nav { display: flex; }
      
      #content { 
          padding: 16px; 
          margin: 0; 
          border-radius: 0; 
          padding-bottom: 150%; 
          height: auto;
          overflow: visible;
      }

      .top-bar { margin: 0 -16px 10px -16px; padding: 0 16px; height: 56px; }
      
      #main-wrapper { display: block; height: auto; overflow: visible; padding: 0; } 
      
      #player-bar { 
        position: fixed;
        bottom: calc(var(--nav-height) + 8px); height: 56px; 
        padding: 0 8px; background: rgba(20,20,20,0.98); 
        border-radius: 6px; margin: 0 8px; 
        width: auto; left: 0; right: 0; border: none; z-index: 100;
        box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      }
      .player-center, .player-right { display: none; }
      .player-left { width: 100%; justify-content: space-between; }
      .mobile-mini-play { display: flex !important; font-size: 24px; margin-right: 10px; color: #fff; cursor: pointer; }
      
      #mini-like-btn { display: none !important; }

      .grid { grid-template-columns: 1fr 1fr; gap: 12px; }
      .genre-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
      .genre-card { height: 100px; }
      .genre-title { font-size: 16px; padding: 12px; }
      .genre-img { width: 60px; height: 60px; }
      .genre-img i { font-size: 30px; }
      
      .track-list-item { 
          grid-template-columns: 1fr 40px; 
          padding: 8px 4px; 
          margin: 0;
      }
      .track-list-item div:nth-child(1), .track-list-item div:nth-child(5) { display: none; }
      .track-list-item div:nth-child(2) { display: none; }
      .track-list-item div:nth-child(2) { display: block; margin-right: 12px; }
      .track-list-item { display: flex; }
      .track-title { display: block !important; }

      .pl-cover-large { width: 180px; height: 180px; margin: 0 auto 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
      .pl-header { flex-direction: column; align-items: center; text-align: center; }
      .pl-name { font-size: 28px; }
      .pl-details { align-items: center; }

      .edit-grid { flex-direction: column; align-items: center; text-align: center; }
      .edit-inputs { text-align: center; }
      
      /* BOTTOM SHEET MOBILE */
      .context-menu.active {
          position: fixed;
          bottom: 0;
          left: 0 !important;
          top: auto !important;
          width: 100%;
          border-radius: 16px 16px 0 0;
          animation: slideUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
          padding-bottom: 30px; 
          border-top: 1px solid rgba(255,255,255,0.1);
      }
      @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
      .ctx-item { padding: 16px 20px; font-size: 16px; }
    }
    .mobile-mini-play { display: none; }

      /* Layout Grid para Desktop (3 colunas: Sidebar - Content - RightPanel) */
      @media (min-width: 1000px) {
          #main-wrapper {
              display: grid !important;
              grid-template-columns: 280px 1fr 280px !important;
              grid-template-areas: "nav content right";
          }
          #sidebar { grid-area: nav; width: 100% !important; }

          #right-sidebar {
              grid-area: right;
              background-color: #121212;
              border-left: 1px solid #282828;
              padding: 20px;
              display: flex;
              flex-direction: column;
              overflow-y: auto;
              border-radius: 8px;
              margin-left: 8px;
          }
      }

      /* Esconde o player lateral em telas menores */
      @media (max-width: 999px) {
          #right-sidebar { display: none !important; }
      }

      /* Estilo do Player Lateral */
      .rs-header {
          font-size: 16px;
          font-weight: 700;
          margin-bottom: 20px;
          color: #fff;
      }
      .rs-art {
          width: 100%;
          aspect-ratio: 1;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.5);
          margin-bottom: 20px;
          object-fit: cover;
      }
      .rs-info h2 {
          font-size: 20px;
          font-weight: 700;
          margin-bottom: 8px;
          color: #fff;
          white-space: nowrap; 
          overflow: hidden; 
          text-overflow: ellipsis; 
          line-height: 1.2;
      }
      .rs-info p {
          font-size: 16px;
          color: #b3b3b3;
          margin-bottom: 20px;
          white-space: nowrap; 
          overflow: hidden; 
          text-overflow: ellipsis;
      }
      .rs-about {
          margin-top: 20px;
          padding: 16px;
          background: #242424;
          border-radius: 8px;
      }

      /* Filtros de Busca */
      .search-filters {
          display: flex;
          gap: 10px;
          margin: 15px 0 25px 0;
      }
      .filter-chip {
          padding: 8px 16px;
          border-radius: 20px;
          background: #2a2a2a;
          color: #fff;
          font-size: 14px;
          cursor: pointer;
          border: none;
          transition: 0.2s;
          font-weight: 500;
      }
      .filter-chip:hover { background: #3e3e3e; }
      .filter-chip.active {
          background: #fff;
          color: #000;
      }

      /* Ajuste nos resultados de playlist */
      .pl-result-card {
          background: #181818;
          padding: 16px;
          border-radius: 8px;
          transition: background 0.3s ease;
          cursor: pointer;
          display: flex;
          flex-direction: column;
          align-items: center;
          text-align: center;
          position: relative;
      }
      .pl-result-card:hover { background: #282828; }
      .pl-result-img {
          width: 100%;
          aspect-ratio: 1;
          border-radius: 4px;
          margin-bottom: 16px;
          object-fit: cover;
          box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      }
  </style>
</head>
<body>

  <div id="toast-container"></div>

  <div id="main-wrapper">
    <nav id="sidebar">
       <div class="sidebar-block" style="margin-bottom: 8px;">
         <div class="logo">
             <img src="logo.png" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fa-solid fa-music\' style=\'font-size:32px;margin-right:8px;\'></i> Exlify'"> 
             Exlify
         </div>
         <div class="nav-btn active" onclick="app.switchView('home')"><i class="fa-solid fa-house"></i> Início</div>
         <div class="nav-btn" onclick="app.switchView('search')"><i class="fa-solid fa-magnifying-glass"></i> Buscar</div>
       </div>

       <div class="sidebar-block" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
         <div class="library-header">
            <span onclick="app.switchView('library')"><i class="fa-solid fa-book" style="margin-right: 0;"></i> Sua Biblioteca</span>
            <div style="display:flex; gap:10px;">
                <i class="fa-solid fa-download pointer" onclick="app.openImportModal()" title="Importar do YouTube" style="font-size: 14px; padding-top:2px;"></i>
                <i class="fa-solid fa-plus pointer" onclick="app.openCreatePlaylistModal()" title="Criar Playlist"></i>
            </div>
         </div>
         
         <div class="library-scroll" id="playlist-list">
         </div>
       </div>
    </nav>

    <main id="content">
      
      <div class="top-bar">
          <div class="top-bar-nav">
              <button class="back-btn disabled" id="main-back-btn" onclick="app.goBack()"><i class="fa-solid fa-chevron-left"></i></button>
          </div>

          <div id="login-btn-header" class="login-btn-white" onclick="app.openAuthModal()">Entrar</div>
          
          <div id="user-profile-header" class="user-pill hidden" onclick="app.toggleUserMenu(event)">
             <div class="user-avatar" id="header-avatar-container">
                 <i class="fa-regular fa-user" id="header-avatar-icon"></i>
             </div>
             <span id="header-username">Usuário</span>
             <i class="fa-solid fa-caret-down" style="font-size: 12px;"></i>
             
             <div id="user-menu" class="user-menu-dropdown">
                 <div class="um-item" onclick="app.openEditProfile()"><i class="fa-solid fa-pen"></i> Editar Perfil</div>
                 <div style="height:1px; background:#3e3e3e; margin:4px 0;"></div>
                 <div class="um-item" onclick="app.doLogout()"><i class="fa-solid fa-arrow-right-from-bracket"></i> Sair</div>
             </div>
          </div>
      </div>

      <div id="view-home" class="view active">
        <div id="login-cta" class="login-cta hidden">
            <div>
               <h3>Entre para ouvir suas músicas</h3>
               <p>Salve playlists, curta faixas e sincronize seus dados.</p>
            </div>
            <button class="login-btn-white" onclick="app.openAuthModal()">Entrar de graça</button>
        </div>

        <h2 id="greeting-msg">Olá</h2>
        
        <h3 style="margin-top: 30px;">Navegar por todas as seções</h3>
        <div id="genre-container" class="genre-grid"></div>

        <h3>Tocadas Recentemente</h3>
        <div class="grid" id="home-grid"></div>
      </div>

      <div id="view-search" class="view">
        <div class="search-header">
          <div class="search-bar">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input type="text" id="search-input" placeholder="O que você quer ouvir?">
          </div>
        </div>

        <div class="search-filters">
            <button id="filter-video" class="filter-chip active" onclick="app.setSearchType('video')">Músicas</button>
            <button id="filter-playlist" class="filter-chip" onclick="app.setSearchType('playlist')">Playlists</button>
        </div>

        <div id="search-history-container" style="display:none; margin-bottom: 20px;">
           <h3>Buscas Recentes</h3>
           <div id="search-history-list" class="grid" style="grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));"></div>
        </div>
        <h3 id="search-res-title">Resultados</h3>
        <div id="search-results" style="display:flex; flex-direction:column; gap:2px;">
           <div style="text-align:center; color:#777; margin-top:40px;">
             Busque por músicas, artistas ou playlists do YouTube.
           </div>
        </div>
      </div>

      <div id="view-playlist" class="view">
         <div id="pl-header-bg" class="pl-header">
            <div id="pl-cover" class="pl-cover-large">
               <i class="fa-solid fa-music"></i>
            </div>
            <div class="pl-details">
              <div class="pl-type">Playlist</div>
              <h1 id="pl-title" class="pl-name">Nome da Playlist</h1>
              <div class="pl-meta">
                 <span id="pl-owner">Exlify User</span> • <span id="pl-count">0 músicas</span>
                 <i id="btn-edit-pl" class="fa-solid fa-pencil pointer" style="margin-left: 10px; font-size: 14px; opacity: 0.6;" onclick="app.openEditPlaylistModal()"></i>
              </div>
            </div>
         </div>
         
         <div style="padding: 24px 0; display: flex; align-items: center; gap: 32px;">
             <div class="play-icon" style="width: 56px; height: 56px; background: var(--sp-green); border-radius: 50%; box-shadow: 0 8px 8px rgba(0,0,0,0.3);" onclick="app.playPlaylistContext()">
                 <i class="fa-solid fa-play" style="margin-left: 4px; font-size: 24px;"></i>
             </div>
             <i id="pl-action-btn" class="fa-solid fa-ellipsis" style="font-size: 28px; color: #b3b3b3; cursor: pointer;" onclick="app.openPlaylistHeaderMenu(event)"></i>
         </div>

         <div style="display: grid; grid-template-columns: 40px 50px 1fr 40px 60px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 16px; color: #b3b3b3; font-size: 12px; text-transform: uppercase; margin-right: -16px; margin-left: -16px; padding-left: 16px; padding-right: 16px;">
             <div style="text-align: center;">#</div>
             <div></div>
             <div>Título</div>
             <div></div>
             <div style="text-align: center;"><i class="fa-regular fa-clock"></i></div>
         </div>
         
         <div id="pl-tracks-container"></div>
      </div>

      <div id="view-library" class="view">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
              <h2>Sua Biblioteca</h2>
              <div style="display: flex; gap: 15px;">
                  <i class="fa-solid fa-download pointer" style="font-size:24px;" onclick="app.openImportModal()" title="Importar"></i>
                  <i class="fa-solid fa-plus pointer" style="font-size:24px;" onclick="app.openCreatePlaylistModal()" title="Criar"></i>
              </div>
          </div>
          <div id="mobile-lib-list"></div>
      </div>

    </main>

    <aside id="right-sidebar">
        <div class="rs-header">Tocando Agora</div>
        <img id="rs-art" class="rs-art" src="https://i.ytimg.com/vi/m7Bc3pLyjk0/mqdefault.jpg" onerror="this.src='logo.png'">
        <div class="rs-info">
            <h2 id="rs-title">Título da Música</h2>
            <p id="rs-artist">Artista</p>
        </div>
        <div class="rs-about">
            <h3 style="font-size:14px; margin-bottom:10px; color:#fff;">Sobre o artista</h3>
            <div id="rs-about-img" style="width:100%; height:120px; background:#333; border-radius:4px; margin-bottom:10px; background-size:cover; background-position:center;"></div>
            <p style="font-size:13px; color:#b3b3b3;">Tocando a partir da sua biblioteca.</p>
        </div>
    </aside>

  </div>

  <footer id="player-bar" onclick="app.handlePlayerBarClick(event)">
    <div class="player-left">
      <img id="mini-thumb" src="https://i.ytimg.com/vi/m7Bc3pLyjk0/mqdefault.jpg" loading="lazy" onerror="this.src='logo.png'">
      <div class="current-info">
        <h4 id="mini-title">Exlify</h4>
        <p id="mini-artist">Escolha uma música</p>
      </div>
      <i class="fa-regular fa-heart" id="mini-like-btn" style="margin-left:15px; color:#b3b3b3; cursor: pointer; transition: 0.2s;" onclick="app.toggleLike(event)"></i>
    </div>

    <div class="player-center">
      <div class="controls">
        <i class="fa-solid fa-shuffle" id="btn-shuffle" onclick="app.toggleShuffle()" title="Aleatório"></i>
        <i class="fa-solid fa-backward-step" onclick="app.prevTrack(event)" title="Voltar (Seta Esquerda)"></i>
        <div class="play-icon" id="main-play-btn-wrapper" onclick="app.togglePlay(event)">
           <i class="fa-solid fa-play" id="main-play-icon" style="margin-left:2px;"></i>
        </div>
        <i class="fa-solid fa-forward-step" onclick="app.nextTrack(event)" title="Avançar (Seta Direita)"></i>
        <i class="fa-solid fa-repeat" id="btn-repeat" onclick="app.toggleRepeat()" title="Repetir"></i>
      </div>
      
      <div class="progress-container" onclick="event.stopPropagation()">
        <span id="curr-time">0:00</span>
        <input type="range" id="seek-bar" class="sp-range" value="0" min="0" max="100" step="0.1">
        <span id="tot-time">0:00</span>
      </div>
    </div>

    <div class="player-right">
       <i class="fa-brands fa-chromecast cast-btn" id="cast-btn-desktop" onclick="app.toggleCast()" title="Transmitir para TV"></i>
       <i class="fa-solid fa-ellipsis" id="desk-player-dots" title="Mais opções"></i>
       <div class="vol-wrapper">
           <i class="fa-solid fa-volume-high" id="vol-icon" style="margin-right:8px;"></i>
           <input type="range" id="vol-bar" class="sp-range" style="width:80px;" value="100" min="0" max="100" oninput="app.setVolume(this.value)">
       </div>
    </div>
    
    <i class="fa-solid fa-play mobile-mini-play" id="mobile-mini-icon" onclick="app.togglePlay(event)"></i>
  </footer>

  <nav id="mobile-nav">
    <div class="mobile-item active" onclick="app.switchView('home')"><i class="fa-solid fa-house"></i> Início</div>
    <div class="mobile-item" onclick="app.switchView('search')"><i class="fa-solid fa-magnifying-glass"></i> Buscar</div>
    <div class="mobile-item" onclick="app.switchView('library')"><i class="fa-solid fa-book"></i> Biblioteca</div>
  </nav>

  <div id="full-player">
     <div class="fp-header">
        <i class="fa-solid fa-chevron-down" style="font-size:24px; cursor:pointer;" onclick="app.closeFullPlayer()"></i>
        <span style="font-size:12px; font-weight:700; letter-spacing:1px;">TOCANDO AGORA</span>
        <i class="fa-solid fa-ellipsis" id="fp-dots" style="font-size:24px; cursor: pointer;"></i>
     </div>
     
     <div class="fp-content-wrapper">
         <div class="fp-art-container">
            <img id="fp-art" class="fp-art" src="" loading="lazy" onerror="this.src='logo.png'">
            <div id="fp-lyrics" class="lyrics-container">
               <div class="lyrics-line">Toque para carregar a letra</div>
               <div style="font-size:14px; margin-top:20px; color:#b3b3b3;">(Letras sincronizadas requerem API premium)</div>
            </div>
            <button class="lyrics-btn" id="btn-toggle-lyrics" style="position: absolute; bottom: 10px; right: 10px;" onclick="app.toggleLyrics()">LETRAS</button>
         </div>
         
         <div style="margin-bottom:20px; flex-shrink: 0;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
               <div style="overflow:hidden; padding-right:10px;">
                  <h2 id="fp-title" class="text-truncate" style="color:#fff; margin-bottom:5px; font-size: 22px;">Título</h2>
                  <p id="fp-artist" class="text-truncate" style="color:#b3b3b3; font-size: 16px;">Artista</p>
               </div>
               <i class="fa-regular fa-heart" id="fp-like-btn" style="font-size:28px; color:#1ed760; transition:0.2s;" onclick="app.toggleLike()"></i>
            </div>
         </div>

         <div class="fp-controls">
            <div class="progress-container">
               <span id="fp-curr-time">0:00</span>
               <input type="range" id="fp-seek-bar" class="sp-range" value="0" min="0" max="100">
               <span id="fp-tot-time">0:00</span>
            </div>
            
            <div class="fp-main-btns">
               <i class="fa-solid fa-shuffle" id="fp-btn-shuffle" style="font-size:24px; color:#b3b3b3;" onclick="app.toggleShuffle()"></i>
               <i class="fa-solid fa-backward-step" style="font-size:36px; color:#fff;" onclick="app.prevTrack()"></i>
               <div class="fp-play" id="fp-play-btn-wrapper" onclick="app.togglePlay()">
                  <i class="fa-solid fa-play" id="fp-play-icon" style="font-size:32px; margin-left:4px;"></i>
               </div>
               <i class="fa-solid fa-forward-step" style="font-size:36px; color:#fff;" onclick="app.nextTrack()"></i>
               <i class="fa-solid fa-repeat" id="fp-btn-repeat" style="font-size:24px; color:#b3b3b3;" onclick="app.toggleRepeat()"></i>
            </div>

            <div style="display:flex; justify-content:center; margin-top:5px;">
                <i class="fa-brands fa-chromecast cast-btn" id="cast-btn-mobile" style="font-size:24px;" onclick="app.toggleCast()"></i>
            </div>
         </div>
     </div>
  </div>

  <div id="modal-auth" class="modal-overlay">
      <div class="modal-box">
          <img src="logo.png" style="width: 80px; margin-bottom: 20px;" onerror="this.style.display='none'">
          <h2 id="auth-title">Entrar no Exlify</h2>
          
          <div id="form-login">
              <input type="email" id="login-email" class="sp-input" placeholder="Email">
              <input type="password" id="login-pass" class="sp-input" placeholder="Senha">
              <button class="sp-btn sp-btn-primary" onclick="app.loginEmail()">Entrar</button>
              <button class="sp-btn sp-btn-google" onclick="app.loginGoogle()"><i class="fa-brands fa-google"></i> Continuar com Google</button>
              <div class="modal-link" onclick="app.toggleAuthMode()">Não tem conta? Inscreva-se</div>
          </div>

          <div id="form-register" class="hidden">
              <input type="text" id="reg-name" class="sp-input" placeholder="Como devemos chamar você?" maxlength="30">
              <input type="email" id="reg-email" class="sp-input" placeholder="Email">
              <input type="password" id="reg-pass" class="sp-input" placeholder="Crie uma senha">
              <button class="sp-btn sp-btn-primary" onclick="app.registerEmail()">Inscrever-se</button>
              <div class="modal-link" onclick="app.toggleAuthMode()">Já tem conta? Faça login</div>
          </div>
          
          <button class="sp-btn sp-btn-sec" style="margin-top:20px; font-size:12px;" onclick="app.closeModals()">Fechar</button>
      </div>
  </div>

  <div id="modal-profile" class="modal-overlay">
      <div class="modal-box">
          <h3>Editar Perfil</h3>
          
          <div class="edit-profile-img-wrapper" onclick="document.getElementById('edit-profile-file').click()">
              <img id="edit-profile-prev" src="" class="hidden">
              <div id="edit-profile-placeholder"><i class="fa-solid fa-camera"></i></div>
              <div class="edit-overlay-profile"><i class="fa-solid fa-pen"></i></div>
              <input type="file" id="edit-profile-file" hidden accept="image/*">
          </div>

          <input type="text" id="edit-profile-name" class="sp-input" placeholder="Novo nome de usuário" maxlength="30">
          <div style="display:flex; justify-content:flex-end; gap:10px;">
              <button class="sp-btn sp-btn-sec" onclick="app.closeModals()">Cancelar</button>
              <button class="sp-btn sp-btn-primary" onclick="app.saveProfile()">Salvar</button>
          </div>
      </div>
  </div>

  <div id="modal-create-pl" class="modal-overlay">
     <div class="modal-box">
        <h3>Criar Playlist</h3>
        <input type="text" id="new-pl-name" class="sp-input" placeholder="Minha Playlist #1" maxlength="50">
        <div style="display:flex; justify-content:flex-end; gap: 10px;">
           <button class="sp-btn sp-btn-sec" onclick="app.closeModals()">Cancelar</button>
           <button class="sp-btn sp-btn-primary" onclick="app.savePlaylist()">CRIAR</button>
        </div>
     </div>
  </div>

  <div id="modal-import-pl" class="modal-overlay">
      <div class="modal-box">
         <h3>Importar do YouTube</h3>
         <p style="font-size:12px; color:#b3b3b3; margin-bottom:15px;">Cole o link ou ID da playlist do YouTube.</p>
         <input type="text" id="import-pl-url" class="sp-input" placeholder="https://youtube.com/playlist?list=...">
         <div style="display:flex; justify-content:flex-end; gap: 10px;">
            <button class="sp-btn sp-btn-sec" onclick="app.closeModals()">Cancelar</button>
            <button class="sp-btn sp-btn-primary" onclick="app.importPlaylistFromUrl()">IMPORTAR</button>
         </div>
      </div>
   </div>

  <div id="modal-edit-pl" class="modal-overlay">
     <div class="modal-box">
        <h3>Editar Detalhes</h3>
        <div class="edit-grid">
            <div class="edit-cover-wrapper" onclick="document.getElementById('edit-pl-file').click()">
                <img id="edit-pl-img-prev" src="" style="display:none; object-fit:cover; width:100%; height:100%;">
                <div id="edit-pl-icon-prev" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#333;">
                    <i class="fa-solid fa-music" style="font-size:48px; color:#7f7f7f;"></i>
                </div>
                <div class="edit-overlay">
                    <i class="fa-solid fa-pen"></i>
                    <span>Escolher foto</span>
                </div>
                <input type="file" id="edit-pl-file" accept="image/*" style="display:none;">
            </div>
            <div class="edit-inputs">
                <input type="text" id="edit-pl-name" class="sp-input" placeholder="Nome da Playlist" style="margin-top:0;" maxlength="50">
                <input type="text" class="sp-input" placeholder="Descrição (Opcional)" disabled style="cursor:not-allowed; opacity:0.6;">
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; width:100%;">
           <div style="display:flex; gap:10px;">
               <button class="sp-btn sp-btn-danger" style="padding:12px 20px; font-size:12px;" onclick="app.deletePlaylist()">Apagar</button>
               <button class="sp-btn sp-btn-sec" style="padding:12px 20px; font-size:12px;" onclick="app.removePlaylistCover()">Remover Foto</button>
           </div>
           <div>
               <button class="sp-btn sp-btn-sec" onclick="app.closeModals()">Cancelar</button>
               <button class="sp-btn sp-btn-primary" onclick="app.confirmEditPlaylist()">SALVAR</button>
           </div>
        </div>
     </div>
  </div>

  <div id="modal-sel-pl" class="modal-overlay">
     <div class="modal-box">
       <h3>Adicionar à Playlist</h3>
       <div id="sel-pl-list" style="max-height:240px; overflow-y:auto; text-align:left; margin:20px 0; border: 1px solid #333; border-radius: 4px; display: flex; flex-direction: column; gap: 4px;"></div>
       <button class="sp-btn sp-btn-primary" onclick="app.closeModalsAndSave()">Concluído</button>
     </div>
  </div>

  <div id="ctx-menu" class="context-menu"></div>

  <audio id="main-audio" style="display:none;" crossorigin="anonymous"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCCfscTwkS20CYqwIj0DRdT4dUIdYwv5cM",
      authDomain: "spotfeike.firebaseapp.com",
      projectId: "spotfeike",
      storageBucket: "spotfeike.firebasestorage.app",
      messagingSenderId: "275170038515",
      appId: "1:275170038515:web:57c9f5dc22e79a0ff65d86",
      measurementId: "G-PMYLBS84C3"
    };

    const fbApp = initializeApp(firebaseConfig);
    const auth = getAuth(fbApp);
    const db = getFirestore(fbApp);
    const provider = new GoogleAuthProvider();

    const GENRES = [
      { name: "Pop", color: "#8d67ab", icon: "fa-music" },
      { name: "Rock", color: "#e91429", icon: "fa-guitar" },
      { name: "Hip-Hop", color: "#ba5d07", icon: "fa-microphone-lines" },
      { name: "Eletrônica", color: "#006450", icon: "fa-bolt" },
      { name: "Funk", color: "#e61e32", icon: "fa-drum" },
      { name: "Sertanejo", color: "#bc5900", icon: "fa-hat-cowboy" },
      { name: "Relax", color: "#477d95", icon: "fa-spa" },
      { name: "Treino", color: "#777777", icon: "fa-dumbbell" }
    ];

    const MOCK_DATA = [
      { id: 'm7Bc3pLyjk0', title: 'Sweater Weather', artist: 'The Neighbourhood', thumb: 'https://i.ytimg.com/vi/m7Bc3pLyjk0/mqdefault.jpg', time: '4:00' },
      { id: '0KSOMA3QBU0', title: 'Dark Horse', artist: 'Katy Perry', thumb: 'https://i.ytimg.com/vi/0KSOMA3QBU0/mqdefault.jpg', time: '3:35' },
      { id: 'lp-EO5I60KA', title: 'Thinking Out Loud', artist: 'Ed Sheeran', thumb: 'https://i.ytimg.com/vi/lp-EO5I60KA/mqdefault.jpg', time: '4:41' },
      { id: 'fJ9rUzIMcZQ', title: 'Bohemian Rhapsody', artist: 'Queen', thumb: 'https://i.ytimg.com/vi/fJ9rUzIMcZQ/mqdefault.jpg', time: '5:55' },
      { id: 'RgKAFK5djSk', title: 'See You Again', artist: 'Wiz Khalifa', thumb: 'https://i.ytimg.com/vi/RgKAFK5djSk/mqdefault.jpg', time: '3:49' },
      { id: 'kJQP7kiw5Fk', title: 'Despacito', artist: 'Luis Fonsi', thumb: 'https://i.ytimg.com/vi/kJQP7kiw5Fk/mqdefault.jpg', time: '3:48' },
      { id: 'nfWlot6h_JM', title: 'Shake It Off', artist: 'Taylor Swift', thumb: 'https://i.ytimg.com/vi/nfWlot6h_JM/mqdefault.jpg', time: '3:39' },
      { id: 'hT_nvWreIhg', title: 'Counting Stars', artist: 'OneRepublic', thumb: 'https://i.ytimg.com/vi/hT_nvWreIhg/mqdefault.jpg', time: '4:17' }
    ];

    const IMGBB_KEY = "753a069314b2b06edaef1e8bcd5fc9ea";
    const YT_API_KEY = "AIzaSyAW1Zm58IklfW1lYo9Wv0cwSVBsrHyiPWA";

    const app = {
      player: null,
      playlist: [],
      queue: [], // Fila de reprodução
      currentIndex: 0,
      
      user: null,
      isShuffle: false,
      repeatMode: 0, 
      sleepTimer: null,
      
      state: {
        playlists: [],
        likes: [],
        lastPlayed: null, 
        ctxTrack: null
      },
      
      history: [],
      tempPlaylistObj: null,
      viewStack: [],
      isBackNav: false,
      searchType: 'video', 
      isLyricsMode: false,

      // Cast variables
      castSession: null,
      remotePlayer: null,
      remotePlayerController: null,

      init: function() {
        this.player = document.getElementById('main-audio');
        
        if('serviceWorker' in navigator){
           navigator.serviceWorker.register('/service-worker.js').catch(e => console.log("SW Error:", e));
        }

        // Cache Inicial (Local Storage) - Carrega antes do Firebase
        this.loadLocalData();

        // Offline Check
        window.addEventListener('offline', () => this.showToast("Sem conexão com a internet.", "offline"));
        window.addEventListener('online', () => this.showToast("Conexão restabelecida.", "success"));

        this.setupPlayerEvents();
        this.loadHistory();
        this.renderHome();
        this.setupEventListeners();
        this.setupKeyboardControls();
        
        // Initialize Cast
        this.initCast();

        onAuthStateChanged(auth, async (user) => {
            this.user = user;
            if (user) {
                document.getElementById('login-cta').classList.add('hidden');
                document.getElementById('login-btn-header').classList.add('hidden');
                document.getElementById('user-profile-header').classList.remove('hidden');
                document.getElementById('header-username').textContent = user.displayName || "Usuário";
                
                // Update avatar
                this.updateHeaderAvatar(user.photoURL);

                await this.loadUserData(user.uid);
            } else {
                this.state.playlists = [];
                this.state.likes = [];
                // Se saiu, tenta carregar local anônimo se houver, ou limpa
                document.getElementById('login-cta').classList.remove('hidden');
                document.getElementById('login-btn-header').classList.remove('hidden');
                document.getElementById('user-profile-header').classList.add('hidden');
                this.renderSidebarPlaylists();
            }
        });

        document.getElementById('edit-pl-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('edit-pl-img-prev').src = e.target.result;
                    document.getElementById('edit-pl-img-prev').style.display = 'block';
                    document.getElementById('edit-pl-icon-prev').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });

        // Edit Profile File Input
        document.getElementById('edit-profile-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const prev = document.getElementById('edit-profile-prev');
                    prev.src = e.target.result;
                    prev.classList.remove('hidden');
                    document.getElementById('edit-profile-placeholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('content').addEventListener('scroll', function() {
            const topBar = document.querySelector('.top-bar');
            if(this.scrollTop > 50) topBar.classList.add('scrolled');
            else topBar.classList.remove('scrolled');
        });

        // Dynamic background update
        setInterval(() => this.updateGradient(), 60000);
      },

      initCast: function() {
        window['__onGCastApiAvailable'] = (isAvailable) => {
          if (isAvailable) {
            cast.framework.CastContext.getInstance().setOptions({
              receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
              autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
            });
            
            this.remotePlayer = new cast.framework.RemotePlayer();
            this.remotePlayerController = new cast.framework.RemotePlayerController(this.remotePlayer);
            this.remotePlayerController.addEventListener(
              cast.framework.RemotePlayerEventType.IS_CONNECTED_CHANGED,
              this.handleCastConnection.bind(this)
            );
            this.remotePlayerController.addEventListener(
                cast.framework.RemotePlayerEventType.CURRENT_TIME_CHANGED,
                this.handleCastTimeUpdate.bind(this)
            );
          }
        };
      },

      handleCastConnection: function(event) {
          const isConnected = event.value;
          this.castSession = cast.framework.CastContext.getInstance().getCurrentSession();
          
          const castBtns = [document.getElementById('cast-btn-desktop'), document.getElementById('cast-btn-mobile')];
          castBtns.forEach(btn => {
              if (isConnected) btn.classList.add('connected');
              else btn.classList.remove('connected');
          });

          if (isConnected) {
              this.showToast("Conectado ao Chromecast", "success");
              // If playing locally, transfer to cast
              if (!this.player.paused && this.currentTrack) {
                  this.player.pause();
                  this.playAudio(this.currentTrack);
              }
          } else {
              this.showToast("Desconectado do Chromecast", "success");
              // Stop remote playback logic if needed
          }
      },
      
      toggleCast: function() {
          if(cast && cast.framework) {
              cast.framework.CastContext.getInstance().requestSession();
          } else {
              this.showToast("Cast não disponível", "error");
          }
      },

      handleCastTimeUpdate: function(event) {
          if(!this.castSession) return;
          const cur = event.value;
          const dur = this.remotePlayer.duration || 180;
          const pct = (cur / dur) * 100;

          ['seek-bar', 'fp-seek-bar'].forEach(id => {
             const el = document.getElementById(id);
             if(el && document.activeElement !== el) { 
                 el.value = pct;
                 el.style.setProperty('--progress-percent', `${pct}%`);
             }
          });
          
          document.getElementById('curr-time').textContent = this.fmtTime(cur);
          document.getElementById('tot-time').textContent = this.fmtTime(dur);
          document.getElementById('fp-curr-time').textContent = this.fmtTime(cur);
          document.getElementById('fp-tot-time').textContent = this.fmtTime(dur);
      },

      updateHeaderAvatar: function(url) {
          const container = document.getElementById('header-avatar-container');
          if (url) {
              container.innerHTML = `<img src="${url}">`;
          } else {
              container.innerHTML = `<i class="fa-regular fa-user" id="header-avatar-icon"></i>`;
          }
      },
      
      updateGradient: function() {
          const hours = new Date().getHours();
          let color1 = "#202020";
          if (hours >= 6 && hours < 12) color1 = "#453a20"; // Morning
          else if (hours >= 12 && hours < 18) color1 = "#203040"; // Afternoon
          else color1 = "#201020"; // Night
          document.getElementById('content').style.background = `linear-gradient(180deg, ${color1} 0%, #121212 300px)`;
      },
      
      loadHistory: function() {
          const h = localStorage.getItem('exli_history');
          if(h) { try { this.history = JSON.parse(h); } catch(e) { this.history = []; } }
      },
      
      addToHistory: function(track) {
          this.history = this.history.filter(t => t.id !== track.id);
          this.history.unshift(track);
          if(this.history.length > 10) this.history = this.history.slice(0, 10);
          localStorage.setItem('exli_history', JSON.stringify(this.history));
          if(document.getElementById('view-search').classList.contains('active')) this.renderSearchHistory();
      },

      // CACHE SYSTEM
      loadLocalData: function() {
          const cached = localStorage.getItem('exli_cache');
          if(cached) {
              try {
                  const data = JSON.parse(cached);
                  this.state.playlists = data.playlists || [];
                  this.state.likes = data.likes || [];
                  this.renderSidebarPlaylists();
                  console.log("Loaded from cache");
              } catch(e) {
                  console.error("Cache corrupted");
              }
          }
      },

      saveLocalData: function() {
          const data = {
              playlists: this.state.playlists,
              likes: this.state.likes
          };
          localStorage.setItem('exli_cache', JSON.stringify(data));
      },

      loadUserData: async function(uid) {
         try {
             const docRef = doc(db, "users", uid);
             const docSnap = await getDoc(docRef);
             if(docSnap.exists()) {
                 const data = docSnap.data();
                 this.state.playlists = data.playlists || [];
                 this.state.likes = data.likes || [];
                 // Atualiza cache local com dados da nuvem
                 this.saveLocalData();
             } else {
                 await setDoc(docRef, { playlists: [], likes: [], lastPlayed: null });
             }
             this.renderSidebarPlaylists();
         } catch(e) { console.error("Error loading data", e); }
      },

      saveUserData: async function() {
          // Salva Localmente Primeiro (Instantâneo)
          this.saveLocalData();

          if(!this.user) return;
          try {
              await setDoc(doc(db, "users", this.user.uid), {
                  playlists: this.state.playlists,
                  likes: this.state.likes,
                  lastPlayed: this.state.lastPlayed
              }, { merge: true });
          } catch(e) { console.error("Error saving data", e); }
      },

      openAuthModal: function() {
          document.getElementById('modal-auth').style.display = 'flex';
          document.getElementById('form-login').classList.remove('hidden');
          document.getElementById('form-register').classList.add('hidden');
          document.getElementById('auth-title').innerText = "Entrar no Exlify";
      },
      
      toggleAuthMode: function() {
          const login = document.getElementById('form-login');
          const reg = document.getElementById('form-register');
          const title = document.getElementById('auth-title');
          if(login.classList.contains('hidden')) {
              login.classList.remove('hidden');
              reg.classList.add('hidden');
              title.innerText = "Entrar no Exlify";
          } else {
              login.classList.add('hidden');
              reg.classList.remove('hidden');
              title.innerText = "Inscrever-se grátis";
          }
      },

      loginEmail: async function() {
          const email = document.getElementById('login-email').value;
          const pass = document.getElementById('login-pass').value;
          try {
              await signInWithEmailAndPassword(auth, email, pass);
              this.closeModals();
              this.showToast("Login realizado com sucesso!", "success");
          } catch(e) { this.showToast("Erro: " + e.message, "error"); }
      },

      registerEmail: async function() {
          const email = document.getElementById('reg-email').value;
          const pass = document.getElementById('reg-pass').value;
          const name = document.getElementById('reg-name').value;
          if (name.length > 30) { this.showToast("Nome muito longo!", "error"); return; }
          try {
              const cred = await createUserWithEmailAndPassword(auth, email, pass);
              await updateProfile(cred.user, { displayName: name });
              this.closeModals();
              this.showToast("Conta criada! Bem-vindo(a).", "success");
              window.location.reload(); 
          } catch(e) { this.showToast("Erro: " + e.message, "error"); }
      },

      loginGoogle: async function() {
          try {
              await signInWithPopup(auth, provider);
              this.closeModals();
              this.showToast("Logado com Google!", "success");
          } catch(e) { this.showToast("Erro: " + e.message, "error"); }
      },

      toggleUserMenu: function(e) {
          e.stopPropagation();
          const menu = document.getElementById('user-menu');
          menu.classList.toggle('active');
          if(menu.classList.contains('active')) {
              document.addEventListener('click', () => menu.classList.remove('active'), {once:true});
          }
      },

      openEditProfile: function() {
          if(!this.user) return;
          document.getElementById('edit-profile-name').value = this.user.displayName;
          document.getElementById('modal-profile').style.display = 'flex';
          
          // Reset Image preview
          if(this.user.photoURL) {
              const prev = document.getElementById('edit-profile-prev');
              prev.src = this.user.photoURL;
              prev.classList.remove('hidden');
              document.getElementById('edit-profile-placeholder').classList.add('hidden');
          } else {
              document.getElementById('edit-profile-prev').classList.add('hidden');
              document.getElementById('edit-profile-placeholder').classList.remove('hidden');
          }
          document.getElementById('edit-profile-file').value = "";
      },

      saveProfile: async function() {
          const newName = document.getElementById('edit-profile-name').value;
          const fileInput = document.getElementById('edit-profile-file');
          
          if(newName.length > 30) { this.showToast("Nome muito longo (máx 30)", "error"); return; }
          
          if(this.user) {
              this.showToast("Salvando perfil...", "success");
              let photoURL = this.user.photoURL;

              if(fileInput.files.length > 0) {
                  const url = await this.uploadImageToImgBB(fileInput.files[0]);
                  if(url) photoURL = url;
              }

              await updateProfile(this.user, { displayName: newName, photoURL: photoURL });
              document.getElementById('header-username').textContent = newName;
              this.updateHeaderAvatar(photoURL);
              
              this.closeModals();
              this.showToast("Perfil atualizado!", "success");
          }
      },

      doLogout: async function() {
          await signOut(auth);
          this.showToast("Você saiu da conta.", "success");
          this.renderHome();
      },

      // FIX: Robust playAudio to prevent "undefined" error
      playAudio: function(video) {
         if (!video) return;

         // Check for valid ID
         const vId = video.videoId || video.id;
         if (!vId || vId === 'undefined' || vId === 'null') {
             console.error("Invalid Video ID:", video);
             this.showToast("Erro: Música indisponível (ID inválido).", "error");
             return;
         }

         this.currentTrack = video; 
         this.addToHistory(video);
         this.updatePlayerUI(video);
         this.updateTrackHighlight();
         this.updatePlayIcons(true); 

         
// CHECK CHROMECAST
if (this.castSession) {
    // ⚠️ URL PRECISA ser pública (nada de localhost)
    const castUrl = `/api/audio?v=${vId}`; // use SOMENTE se essa rota for pública

    const mediaInfo = new chrome.cast.media.MediaInfo(castUrl, 'audio/mp3');

    const metadata = new chrome.cast.media.MusicTrackMediaMetadata();
    metadata.title = video.title || 'Sem título';
    metadata.artist = video.artist || video.author || 'Desconhecido';
    metadata.images = [
        { url: video.thumb }
    ];

    mediaInfo.metadata = metadata;

    const request = new chrome.cast.media.LoadRequest(mediaInfo);
    request.autoplay = true;

    this.castSession.loadMedia(request).then(
        () => console.log('✅ Cast carregado'),
        (err) => console.log('❌ Erro no Cast', err)
    );

    return; // IMPORTANTE: impede tocar local ao mesmo tempo
}

// Local Playback
this.player.src = `/api/audio?v=${vId}`;

const handleAudioError = () => {
    console.log("Audio API failed, usando fallback");
    this.player.src = "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3";
    this.player.play().catch(() => {});
};

this.player.removeEventListener('error', handleAudioError);
this.player.addEventListener('error', handleAudioError, { once: true });

         this.player.play().catch(e => {
             console.log("Autoplay blocked or error", e);
             handleAudioError();
         });
         
         this.setBuffering(true); 

         if('mediaSession' in navigator){
            navigator.mediaSession.metadata = new MediaMetadata({
                title: video.title,
                artist: video.artist || video.author,
                artwork: [
                    { src: video.thumb, sizes: "512x512", type: "image/jpeg" },
                ]
            });

            navigator.mediaSession.setActionHandler('play', ()=>this.togglePlay());
            navigator.mediaSession.setActionHandler('pause', ()=>this.togglePlay());
            navigator.mediaSession.setActionHandler('seekbackward', ()=> { this.player.currentTime -= 10; });
            navigator.mediaSession.setActionHandler('seekforward', ()=> { this.player.currentTime += 10; });
            navigator.mediaSession.setActionHandler('previoustrack', ()=>this.prevTrack());
            navigator.mediaSession.setActionHandler('nexttrack', ()=>this.nextTrack());
         }
      },

      setupPlayerEvents: function() {
         this.player.addEventListener('ended', () => {
             this.nextTrack(); // Use shared nextTrack logic
         });
         
         this.player.addEventListener('waiting', () => { this.setBuffering(true); });
         this.player.addEventListener('playing', () => { this.setBuffering(false); });
         this.player.addEventListener('canplay', () => { this.setBuffering(false); });

         this.player.addEventListener('timeupdate', () => {
             if (this.castSession) return; // Ignore local update if casting
             if(!this.player.duration) return;
             const cur = this.player.currentTime;
             const dur = this.player.duration;
             const pct = (cur / dur) * 100;
             
             ['seek-bar', 'fp-seek-bar'].forEach(id => {
                 const el = document.getElementById(id);
                 if(el && document.activeElement !== el) { 
                     el.value = pct;
                     el.style.setProperty('--progress-percent', `${pct}%`);
                 }
             });
             
             document.getElementById('curr-time').textContent = this.fmtTime(cur);
             document.getElementById('tot-time').textContent = this.fmtTime(dur);
             document.getElementById('fp-curr-time').textContent = this.fmtTime(cur);
             document.getElementById('fp-tot-time').textContent = this.fmtTime(dur);
         });

         this.player.addEventListener('play', () => this.updatePlayIcons(true));
         this.player.addEventListener('pause', () => this.updatePlayIcons(false));
      },
      
      setBuffering: function(isBuffering) {
          const els = [
              document.getElementById('main-play-btn-wrapper'),
              document.getElementById('fp-play-btn-wrapper'),
              document.getElementById('mobile-mini-icon')
          ];
          
          els.forEach(el => {
              if(!el) return;
              if(isBuffering) el.classList.add('buffering');
              else el.classList.remove('buffering');
          });
      },

      playContext: function(trackList, startIndex) {
         this.playlist = trackList;
         this.currentIndex = startIndex;
         this.queue = []; // Clear queue on new context
         this.playAudio(trackList[startIndex]);
      },
      
      playPlaylistContext: function() {
          let tracks = [];
          if(this.tempPlaylistObj && document.getElementById('view-playlist').classList.contains('active') && this.currentPlaylistIndex === null && document.getElementById('pl-title').textContent === this.tempPlaylistObj.title) {
              tracks = this.tempPlaylistObj.songs;
          } else if(this.currentPlaylistIndex === null) {
              tracks = this.state.likes;
          } else if(this.state.playlists[this.currentPlaylistIndex]) {
              tracks = this.state.playlists[this.currentPlaylistIndex].songs;
          }
          if(tracks.length > 0) this.playContext(tracks, 0);
      },

      addToQueue: function(track) {
          this.queue.push(track);
          this.showToast("Adicionado à fila", "success");
      },

      nextTrack: function(e) {
          if(e) e.stopPropagation();
          
          // Check Queue First
          if (this.queue.length > 0) {
              const next = this.queue.shift();
              this.playAudio(next);
              return;
          }

          if(this.playlist.length === 0) return;
          
          if(this.isShuffle) {
              this.currentIndex = Math.floor(Math.random() * this.playlist.length);
              this.playAudio(this.playlist[this.currentIndex]);
          } else if(this.currentIndex < this.playlist.length - 1) {
              this.playAudio(this.playlist[++this.currentIndex]);
          } else if (this.repeatMode === 1) {
              this.currentIndex = 0;
              this.playAudio(this.playlist[0]);
          }
      },

      prevTrack: function(e) {
          if(e) e.stopPropagation();
          if(this.playlist.length === 0) return;
          
          if(!this.castSession && this.player.currentTime > 3) {
             this.player.currentTime = 0;
             return;
          }

          if(this.currentIndex > 0) {
              this.playAudio(this.playlist[--this.currentIndex]);
          } else {
              this.playAudio(this.playlist[0]);
          }
      },

      togglePlay: function(e) {
        if(e) e.stopPropagation();
        
        if (this.castSession) {
            this.remotePlayerController.playOrPause();
            const isPlaying = !this.remotePlayer.isPaused;
            this.updatePlayIcons(isPlaying); // Optimistic update
            return;
        }

        if(this.player.paused) this.player.play();
        else this.player.pause();
      },

      updatePlayIcons: function(isPlaying) {
        const icons = ['main-play-icon', 'mobile-mini-icon', 'fp-play-icon'];
        icons.forEach(id => {
          const el = document.getElementById(id);
          if(!el) return;
          el.className = isPlaying ? "fa-solid fa-pause" : "fa-solid fa-play";
          el.style.marginLeft = isPlaying ? "0" : "2px"; 
        });
      },

      setSearchType: function(type) {
          this.searchType = type;
          document.getElementById('filter-video').classList.toggle('active', type === 'video');
          document.getElementById('filter-playlist').classList.toggle('active', type === 'playlist');
          
          const val = document.getElementById('search-input').value;
          if(val.length > 0) this.doSearch(val);
      },

      doSearch: async function(query) {
         if(!query) return;
         if(!navigator.onLine) { this.showToast("Sem internet para buscar.", "offline"); return; }
         
         const container = document.getElementById('search-results');
         document.getElementById('search-history-container').style.display = 'none';
         document.getElementById('search-res-title').style.display = 'block';
         
         if(this.searchType === 'playlist') {
             container.style.display = 'grid';
             container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(180px, 1fr))';
             container.style.gap = '20px';
             container.style.padding = '20px';
         } else {
             container.style.display = 'flex';
             container.style.flexDirection = 'column';
             container.style.gap = '2px';
             container.style.padding = '0';
         }

         // Skeleton UI em vez de spinner simples
         container.innerHTML = Array(5).fill('<div class="skeleton" style="height: 60px; margin-bottom: 8px; width: 100%;"></div>').join('');
         
         try {
            let data = [];
            
            // LÓGICA DE BUSCA ALTERADA PARA USAR API YOUTUBE EM PLAYLISTS
            if (this.searchType === 'playlist') {
                 const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=playlist&key=${YT_API_KEY}&maxResults=20`);
                 if (!res.ok) throw new Error("404");
                 const json = await res.json();
                 
                 data = json.items.map(item => ({
                     playlistId: item.id.playlistId,
                     title: item.snippet.title,
                     author: item.snippet.channelTitle,
                     thumbnail: item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default?.url,
                     description: item.snippet.description
                 }));

            } else {
                // Mantém a busca original para vídeos/músicas
                try {
                    const res = await fetch(`/api/search?q=${encodeURIComponent(query)}&type=${this.searchType}`);
                    if (!res.ok) throw new Error("404");
                    data = await res.json();
                } catch(fetchError) {
                    await new Promise(r => setTimeout(r, 1000)); 
                    data = MOCK_DATA.map(m => ({ ...m, title: `${m.title} (${query})`, videoId: m.id }));
                }
            }

            if(!data || !data.length) {
                 container.innerHTML = '<div style="padding:20px;text-align:center; width:100%;">Nenhum resultado.</div>';
                 return;
             }
             
             container.innerHTML = "";

             if(this.searchType === 'playlist') {
                 data.forEach(pl => {
                    const div = document.createElement('div');
                    div.className = "pl-result-card fade-in";
                    div.innerHTML = `
                        <img src="${pl.thumbnail || pl.thumb}" class="pl-result-img" loading="lazy" onerror="this.src='logo.png'">
                        <div style="font-weight:700; color:#fff; font-size:14px; margin-bottom:4px;" class="text-truncate">${pl.title}</div>
                        <div style="color:#b3b3b3; font-size:12px;" class="text-truncate">Playlist • ${pl.author || 'YouTube'}</div>
                        <div class="play-btn-hover" style="bottom: 80px; right: 20px;"><i class="fa-solid fa-play" style="margin-left: 2px;"></i></div>
                    `;
                    div.onclick = () => {
                         this.fetchAndOpenYoutubePlaylist(pl.playlistId || pl.id, pl.title, pl.thumbnail || pl.thumb, pl.author);
                    };
                    container.appendChild(div);
                 });
             } else {
                 const mappedResults = data.map(video => ({
                     id: video.videoId || video.id, // Explicit ID fallback
                     videoId: video.videoId || video.id,
                     title: video.title,
                     artist: video.author || video.artist,
                     thumb: video.thumb || video.thumbnail,
                     time: video.duration || "3:00"
                 }));

                 mappedResults.forEach((t, i) => {
                     const div = document.createElement('div');
                     div.className = "track-list-item fade-in";
                     div.style.animationDelay = `${i * 0.05}s`; 
                     
                     // VERIFICA SE É A MÚSICA ATUAL PARA FICAR VERDE
                     let titleClass = "track-title";
                     let isActive = false;
                     if(this.currentTrack && (this.currentTrack.videoId === t.id || this.currentTrack.id === t.id)) {
                         titleClass += " text-green";
                         isActive = true;
                     }

                     div.innerHTML = `
                       <div style="text-align:center;"><i class="fa-solid fa-music ${isActive ? 'text-green' : ''}"></i></div>
                       <div style="display:none;"></div>
                       <img src="${t.thumb}" loading="lazy" onerror="this.src='logo.png'">
                       <div class="meta">
                         <div class="${titleClass}">${t.title}</div>
                         <div class="track-artist">${t.artist}</div>
                       </div>
                       <div style="text-align:right;">
                            <i class="fa-solid fa-ellipsis" onclick="event.stopPropagation(); app.openCtxMenu(event, '${t.id}')"></i>
                       </div>
                       <div></div>
                     `;
                     div.onclick = () => {
                         this.playContext(mappedResults, i);
                     }
                     container.appendChild(div);
                 });
             }

         } catch(e) {
             console.error(e);
             container.innerHTML = '<div style="padding:20px;text-align:center;color:#e91429; width:100%;">Erro na busca.</div>';
         }
      },
      
      fetchAndOpenYoutubePlaylist: async function(id, title, thumb, author) {
          if(!navigator.onLine) { this.showToast("Sem conexão.", "offline"); return; }
          this.showToast("Carregando playlist...", "success");
          try {
              let tracks = [];
              // Importação real via API na hora de abrir
              const res = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${id}&key=${YT_API_KEY}`);
              if(!res.ok) throw new Error("404");
              const json = await res.json();

              tracks = json.items.map(item => ({
                  videoId: item.snippet.resourceId.videoId,
                  title: item.snippet.title,
                  author: item.snippet.videoOwnerChannelTitle,
                  thumbnail: item.snippet.thumbnails.default?.url || item.snippet.thumbnails.medium?.url,
                  duration: "3:00" // API playlistItems doesn't return duration, requires extra call. default for speed.
              }));
              
              if(tracks && tracks.length > 0) {
                  const mappedTracks = tracks.map(v => ({
                      id: v.videoId || v.id, videoId: v.videoId || v.id,
                      title: v.title, artist: v.author || v.artist,
                      thumb: v.thumbnail || v.thumb, time: v.duration || v.time
                  }));
                  
                  this.tempPlaylistObj = {
                      title: title, author: author || "YouTube", thumb: thumb,
                      songs: mappedTracks, id: id, isEditable: false
                  };
                  this.openPlaylistView('external');
              } else {
                  this.showToast("Playlist vazia ou privada.", "error");
              }
          } catch(e) {
              console.log(e);
              this.showToast("Erro ao carregar playlist.", "error");
          }
      },

      toggleShuffle: function() {
          this.isShuffle = !this.isShuffle;
          const color = this.isShuffle ? 'var(--sp-green)' : '#b3b3b3';
          document.getElementById('btn-shuffle').style.color = color;
          document.getElementById('fp-btn-shuffle').style.color = color;
          document.getElementById('btn-shuffle').classList.toggle('active-control', this.isShuffle);
      },

      toggleRepeat: function() {
          this.repeatMode = (this.repeatMode + 1) % 2; 
          const color = this.repeatMode === 1 ? 'var(--sp-green)' : '#b3b3b3';
          ['btn-repeat', 'fp-btn-repeat'].forEach(id => {
              const el = document.getElementById(id);
              el.style.color = color;
              if(this.repeatMode === 1) el.classList.add('active-control');
              else el.classList.remove('active-control');
          });
      },

      setVolume: function(val) {
          if (this.castSession) {
              this.remotePlayer.volumeLevel = val / 100;
              this.remotePlayerController.setVolumeLevel();
          }
          if(this.player) {
              this.player.volume = val / 100;
              const icon = document.getElementById('vol-icon');
              if(val == 0) icon.className = "fa-solid fa-volume-xmark";
              else if(val < 50) icon.className = "fa-solid fa-volume-low";
              else icon.className = "fa-solid fa-volume-high";
              const el = document.getElementById('vol-bar');
              if(el) el.style.setProperty('--progress-percent', `${val}%`);
          }
      },

      // LYRICS FEATURE
      toggleLyrics: function() {
          this.isLyricsMode = !this.isLyricsMode;
          const art = document.getElementById('fp-art');
          const lyrics = document.getElementById('fp-lyrics');
          const btn = document.getElementById('btn-toggle-lyrics');

          if(this.isLyricsMode) {
              art.style.display = 'none';
              lyrics.classList.add('active');
              btn.classList.add('active');
              // Mock Lyrics Sync
              this.updateLyricsUI(true);
          } else {
              art.style.display = 'block';
              lyrics.classList.remove('active');
              btn.classList.remove('active');
          }
      },

      updateLyricsUI: function(simulate) {
          if(!simulate) return;
          const container = document.getElementById('fp-lyrics');
          container.innerHTML = `
              <div class="lyrics-line">Carregando letras...</div>
              <div class="lyrics-line active" style="margin-top: 50px;">${this.currentTrack ? this.currentTrack.title : 'Música'}</div>
              <div class="lyrics-line">Singing along to the rhythm</div>
              <div class="lyrics-line">Feel the beat inside your soul</div>
              <div class="lyrics-line">Visualização de Letras</div>
              <div class="lyrics-line">(Modo Simulação)</div>
          `;
      },

      // KEYBOARD SHORTCUTS
      setupKeyboardControls: function() {
          window.addEventListener('keydown', (e) => {
              if(e.target.tagName === 'INPUT') return; // Ignorar se estiver digitando

              switch(e.code) {
                  case 'Space':
                      e.preventDefault();
                      this.togglePlay();
                      break;
                  case 'ArrowLeft':
                      if(e.ctrlKey) this.prevTrack();
                      else this.player.currentTime -= 5;
                      break;
                  case 'ArrowRight':
                      if(e.ctrlKey) this.nextTrack();
                      else this.player.currentTime += 5;
                      break;
                  case 'KeyM':
                      this.player.muted = !this.player.muted;
                      break;
              }
          });
      },

      fmtTime: function(s) {
        if(!s || isNaN(s)) return "0:00";
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const sc = Math.floor(s % 60);
        if (h > 0) return `${h}:${m < 10 ? '0' + m : m}:${sc < 10 ? '0' + sc : sc}`;
        return `${m}:${sc < 10 ? '0' + sc : sc}`;
      },

      updateSliderBg: function(id, pct) { 
        const el = document.getElementById(id);
        if(el) el.style.setProperty('--progress-percent', `${pct}%`);
      },

      updatePlayerUI: function(t) {
        document.getElementById('mini-title').textContent = t.title;
        document.getElementById('mini-artist').textContent = t.artist || t.author;
        document.getElementById('mini-thumb').src = t.thumb;
        document.getElementById('fp-title').textContent = t.title;
        document.getElementById('fp-artist').textContent = t.artist || t.author;
        document.getElementById('fp-art').src = t.thumb;
        
        document.getElementById('rs-title').textContent = t.title;
        document.getElementById('rs-artist').textContent = t.artist || t.author;
        const rsArt = document.getElementById('rs-art');
        rsArt.src = t.thumb;
        document.getElementById('rs-about-img').style.backgroundImage = `url(${t.thumb})`;

        this.updateLikeBtns(t.id);
        
        const rndColor = this.getRandomColor();
        document.getElementById('full-player').style.background = `linear-gradient(180deg, ${rndColor} 0%, #121212 100%)`;
        
        if(this.isLyricsMode) this.updateLyricsUI(true);
      },

      updateLikeBtns: function(id) {
        const isLiked = this.state.likes.some(x => x.id === id);
        const els = [document.getElementById('mini-like-btn'), document.getElementById('fp-like-btn')];
        els.forEach(el => {
           if(isLiked) {
             el.className = "fa-solid fa-heart";
             el.style.color = "#1ed760";
           } else {
             el.className = "fa-regular fa-heart";
             el.style.color = "#b3b3b3";
           }
        });
      },
      
      updateTrackHighlight: function() {
          document.querySelectorAll('.track-title').forEach(el => el.classList.remove('text-green'));
          document.querySelectorAll('.fa-music').forEach(el => el.classList.remove('text-green'));
          
          if(this.currentTrack) {
              // Atualiza na playlist view
              if(document.getElementById('view-playlist').classList.contains('active')) {
                  this.openPlaylistView('refresh');
              }
          }
      },

      switchView: function(id) {
        if(!this.isBackNav) {
            const currentActive = document.querySelector('.view.active');
            if(currentActive) {
                const currentId = currentActive.id.replace('view-', '');
                if(currentId !== id) this.viewStack.push(currentId);
            }
        }

        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.mobile-item').forEach(e => e.classList.remove('active'));

        document.getElementById('view-' + id).classList.add('active');

        const backBtn = document.getElementById('main-back-btn');
        if (this.viewStack.length > 0) backBtn.classList.remove('disabled');
        else backBtn.classList.add('disabled');

        if (id === 'home') {
           document.querySelectorAll('.nav-btn')[0].classList.add('active');
           document.querySelectorAll('.mobile-item')[0].classList.add('active');
           this.updateGreeting();
           this.updateGradient();
        } else if (id === 'search') {
           document.querySelectorAll('.nav-btn')[1].classList.add('active');
           document.querySelectorAll('.mobile-item')[1].classList.add('active');
           this.renderSearchHistory();
           document.getElementById('search-input').focus();
        } else if (id === 'library') {
           document.querySelectorAll('.mobile-item')[2].classList.add('active');
           this.renderMobileLibrary();
        }
        this.closeFullPlayer();
        document.getElementById('content').scrollTop = 0;
      },
      
      goBack: function() {
         if(this.viewStack.length > 0) {
             this.isBackNav = true;
             const prevView = this.viewStack.pop();
             this.switchView(prevView);
             this.isBackNav = false;
         } else {
             this.switchView('home');
         }
      },
      
      renderSearchHistory: function() {
          const container = document.getElementById('search-history-container');
          const list = document.getElementById('search-history-list');
          const res = document.getElementById('search-results');
          const resTitle = document.getElementById('search-res-title');
          const input = document.getElementById('search-input');
          
          if(input.value.length > 0) {
              container.style.display = 'none';
              res.style.display = 'flex';
              resTitle.style.display = 'block';
              return;
          }

          if(this.history.length > 0) {
              container.style.display = 'block';
              res.style.display = 'none';
              resTitle.style.display = 'none';
              list.innerHTML = "";
              this.history.forEach((t, i) => {
                  const div = document.createElement('div');
                  div.className = "card";
                  div.innerHTML = `
                       <img src="${t.thumb}" loading="lazy" onerror="this.src='logo.png'">
                       <div class="card-title" style="font-size:14px;">${t.title}</div>
                       <div class="card-desc">${t.artist || t.author}</div>
                  `;
                  div.onclick = () => { this.playContext(this.history, i); };
                  list.appendChild(div);
              });
          } else {
              container.style.display = 'none';
              res.style.display = 'flex';
              resTitle.style.display = 'block';
          }
      },

      updateGreeting: function() {
          const h = new Date().getHours();
          let msg = "Bom dia";
          if(h >= 12 && h < 18) msg = "Boa tarde";
          else if(h >= 18) msg = "Boa noite";
          document.getElementById('greeting-msg').textContent = msg;
      },

      renderHome: function() {
        this.updateGreeting();
        const genreGrid = document.getElementById('genre-container');
        genreGrid.innerHTML = "";
        GENRES.forEach(g => {
            const el = document.createElement('div');
            el.className = "genre-card";
            el.style.backgroundColor = g.color;
            el.innerHTML = `<div class="genre-title">${g.name}</div><div class="genre-img"><i class="fa-solid ${g.icon}"></i></div>`;
            el.onclick = () => {
                this.switchView('search');
                document.getElementById('search-input').value = g.name;
                this.setSearchType('video');
                this.doSearch(g.name);
            };
            genreGrid.appendChild(el);
        });

        const grid = document.getElementById('home-grid');
        grid.innerHTML = "";
        
        const likeCard = document.createElement('div');
        likeCard.className = "card";
        likeCard.innerHTML = `
           <div style="width:100%; aspect-ratio:1; background:linear-gradient(135deg,#450af5,#c4efd9); display:flex; center; justify-content:center; align-items:center; border-radius:4px; margin-bottom:16px;">
               <i class="fa-solid fa-heart" style="font-size:40px; color:#fff;"></i>
           </div>
           <div class="play-btn-hover" onclick="event.stopPropagation(); app.openPlaylistView('likes'); app.playPlaylistContext();">
              <i class="fa-solid fa-play" style="margin-left:2px;"></i>
           </div>
           <div class="card-title">Músicas Curtidas</div>
           <div class="card-desc">Suas músicas favoritas</div>
        `;
        likeCard.onclick = () => this.openPlaylistView('likes');
        grid.appendChild(likeCard);

        MOCK_DATA.forEach(t => grid.appendChild(this.createTrackCard(t)));
      },

      createTrackCard: function(t) {
        const div = document.createElement('div');
        div.className = "card";
        div.innerHTML = `
           <img src="${t.thumb}" loading="lazy" onerror="this.src='logo.png'">
           <div class="play-btn-hover" onclick="event.stopPropagation(); app.playContext(MOCK_DATA, MOCK_DATA.findIndex(x=>x.id==='${t.id}'))">
              <i class="fa-solid fa-play" style="margin-left:2px;"></i>
           </div>
           <div class="card-title">${t.title}</div>
           <div class="card-desc">${t.artist}</div>
        `;
        div.onclick = () => { this.playContext(MOCK_DATA, MOCK_DATA.findIndex(x=>x.id === t.id)); };
        return div;
      },

      renderSidebarPlaylists: function() {
         const div = document.getElementById('playlist-list');
         div.innerHTML = "";
         
         const likeItem = document.createElement('div');
         likeItem.className = "playlist-item";
         if(document.getElementById('pl-title').textContent === "Músicas Curtidas" && document.getElementById('view-playlist').classList.contains('active')) {
             likeItem.classList.add('active-pl');
         }

         likeItem.innerHTML = `
            <div style="width:48px;height:48px;background:linear-gradient(135deg,#450af5,#c4efd9);display:flex;align-items:center;justify-content:center;border-radius:4px;flex-shrink:0;"><i class="fa-solid fa-heart" style="color:#fff;"></i></div>
            <div class="pl-info-side"><h4>Músicas Curtidas</h4><p>Playlist • ${this.state.likes.length} músicas</p></div>
         `;
         likeItem.onclick = () => this.openPlaylistView('likes');
         div.appendChild(likeItem);

         this.state.playlists.forEach((pl, idx) => {
            const item = document.createElement('div');
            item.className = "playlist-item";
            if(this.currentPlaylistIndex === idx && document.getElementById('view-playlist').classList.contains('active')) {
                item.classList.add('active-pl');
            }
            
            let imgHTML = `<div style="width:48px;height:48px;background:#333;display:flex;align-items:center;justify-content:center;border-radius:4px;flex-shrink:0;"><i class="fa-solid fa-music" style="color:#7f7f7f;"></i></div>`;
            if(pl.thumb) imgHTML = `<img src="${pl.thumb}" onerror="this.parentElement.innerHTML='<div style=\'width:48px;height:48px;background:#333;display:flex;align-items:center;justify-content:center;border-radius:4px;flex-shrink:0;\'><i class=\'fa-solid fa-music\' style=\'color:#7f7f7f;\'></i></div>'">`;

            item.innerHTML = `${imgHTML}<div class="pl-info-side"><h4>${pl.name}</h4><p>Playlist • ${pl.songs.length} músicas</p></div>`;
            item.onclick = () => this.openPlaylistView('custom', idx);
            item.oncontextmenu = (e) => {
                e.preventDefault();
                if(pl.isEditable === false) return; 
                this.currentPlaylistIndex = idx;
                this.openEditPlaylistModal();
            }
            div.appendChild(item);
         });
         
         if(document.getElementById('view-library').classList.contains('active')) this.renderMobileLibrary();
      },

      renderMobileLibrary: function() {
          const list = document.getElementById('mobile-lib-list');
          list.innerHTML = "";
          
          const likeDiv = document.createElement('div');
          likeDiv.className = "mobile-lib-item";
          likeDiv.innerHTML = `
              <div class="mobile-lib-img" style="background:linear-gradient(135deg,#450af5,#c4efd9);"><i class="fa-solid fa-heart" style="color:#fff;"></i></div>
              <div class="mobile-lib-info"><h4>Músicas Curtidas</h4><p>Playlist • ${this.state.likes.length} músicas</p></div>
          `;
          likeDiv.onclick = () => this.openPlaylistView('likes');
          list.appendChild(likeDiv);

          this.state.playlists.forEach((pl, idx) => {
             const div = document.createElement('div');
             div.className = "mobile-lib-item";
             let imgHTML = `<div class="mobile-lib-img"><i class="fa-solid fa-music" style="color:#7f7f7f;"></i></div>`;
             if(pl.thumb) imgHTML = `<div class="mobile-lib-img"><img src="${pl.thumb}" onerror="this.src='logo.png'"></div>`;

             div.innerHTML = `${imgHTML}<div class="mobile-lib-info"><h4>${pl.name}</h4><p>Playlist • ${pl.songs.length} músicas</p></div>`;
             div.onclick = () => this.openPlaylistView('custom', idx);
             div.oncontextmenu = (e) => {
                e.preventDefault();
                if(pl.isEditable === false) return;
                this.currentPlaylistIndex = idx;
                this.openEditPlaylistModal();
             };
             list.appendChild(div);
          });
      },

      openPlaylistView: function(type, idx) {
         if(type === 'refresh') {
             if(this.currentPlaylistIndex === null && document.getElementById('pl-title').textContent === 'Músicas Curtidas') type = 'likes';
             else if(this.currentPlaylistIndex !== null) { type = 'custom'; idx = this.currentPlaylistIndex; }
             else return;
         }

         this.switchView('playlist');
         const container = document.getElementById('pl-tracks-container');
         container.innerHTML = "";
         
         let title = "", tracks = [], grad = "", coverHTML = "";
         const actionBtn = document.getElementById('pl-action-btn');
         const editBtn = document.getElementById('btn-edit-pl');
         
         actionBtn.style.display = 'block';
         actionBtn.className = "fa-solid fa-ellipsis";
         actionBtn.onclick = (e) => app.openPlaylistHeaderMenu(e);

         if(type === 'likes') {
            title = "Músicas Curtidas";
            tracks = this.state.likes;
            grad = "linear-gradient(to bottom, #5038a0, #121212)";
            coverHTML = '<i class="fa-solid fa-heart" style="color:#fff;"></i>';
            document.getElementById('pl-cover').style.background = "linear-gradient(135deg,#450af5,#c4efd9)";
            document.getElementById('pl-cover').innerHTML = coverHTML;
            this.currentPlaylistIndex = null;
            editBtn.style.display = 'none';
         } else if (type === 'external') {
            const extPl = this.tempPlaylistObj;
            title = extPl.title;
            tracks = extPl.songs;
            grad = `linear-gradient(to bottom, ${this.getRandomColor()}, #121212)`;
            if(extPl.thumb) {
               coverHTML = `<img src="${extPl.thumb}" onerror="this.src='logo.png'">`;
               document.getElementById('pl-cover').style.background = "transparent";
            } else {
               coverHTML = '<i class="fa-solid fa-music"></i>';
               document.getElementById('pl-cover').style.background = "#282828";
            }
            document.getElementById('pl-cover').innerHTML = coverHTML;
            this.currentPlaylistIndex = null; 
            editBtn.style.display = 'none'; 
            document.getElementById('pl-owner').textContent = extPl.author;
            actionBtn.className = "fa-regular fa-heart";
            actionBtn.style.color = "#b3b3b3";
            actionBtn.onclick = (e) => { e.stopPropagation(); app.saveExternalPlaylist(tracks, title, extPl.thumb); };
            
         } else {
            const pl = this.state.playlists[idx];
            title = pl.name;
            tracks = pl.songs;
            grad = `linear-gradient(to bottom, ${this.getRandomColor()}, #121212)`;
            if(pl.thumb) {
                coverHTML = `<img src="${pl.thumb}" onerror="this.src='logo.png'">`;
                document.getElementById('pl-cover').style.background = "transparent";
            } else {
                coverHTML = '<i class="fa-solid fa-music"></i>';
                document.getElementById('pl-cover').style.background = "#282828";
            }
            document.getElementById('pl-cover').innerHTML = coverHTML;
            this.currentPlaylistIndex = idx;
            
            if(pl.isEditable === false) {
                 editBtn.style.display = 'none';
            } else {
                 editBtn.style.display = 'inline-block';
            }
            document.getElementById('pl-owner').textContent = this.user ? this.user.displayName : "Usuário";
         }

         document.getElementById('pl-title').textContent = title;
         document.getElementById('pl-count').textContent = tracks.length + " músicas";
         document.getElementById('pl-header-bg').style.background = grad;
         
         this.renderSidebarPlaylists(); 

         if(tracks.length === 0) {
            container.innerHTML = `<div style="padding:40px; text-align:center; color:#777;">Essa playlist está vazia.</div>`;
         } else {
             tracks.forEach((t, i) => {
                const div = document.createElement('div');
                div.className = "track-list-item fade-in";
                div.style.animationDelay = `${i*0.02}s`;
                let titleClass = "track-title";
                let numContent = i+1;
                let isActive = false;
                
                const currentId = this.currentTrack ? (this.currentTrack.videoId || this.currentTrack.id) : null;
                const itemId = t.videoId || t.id;

                if(currentId && currentId === itemId) {
                    titleClass += " text-green";
                    numContent = `<span class="text-green">${i+1}</span>`;
                    isActive = true;
                }

                div.innerHTML = `
                  <div style="text-align:center;" >${numContent}</div>
                  <img src="${t.thumb}" loading="lazy" onerror="this.src='logo.png'">
                  <div class="meta">
                    <div class="${titleClass}">${t.title}</div>
                    <div class="track-artist">${t.artist || t.author}</div>
                  </div>
                  <div style="text-align:right;">
                     <i class="fa-regular fa-heart hidden" style="font-size:14px; margin-right:10px;"></i> 
                     <i class="fa-solid fa-ellipsis" style="font-size:14px; padding: 8px;" onclick="event.stopPropagation(); app.openCtxMenu(event, '${itemId}')"></i>
                  </div>
                  <div style="text-align:center; font-size:12px;">${t.time || "3:00"}</div>
                `;
                div.onclick = () => this.playContext(tracks, i);
                div.oncontextmenu = (e) => { e.preventDefault(); app.openCtxMenu(e, itemId); };
                container.appendChild(div);
             });
         }
      },

      openCreatePlaylistModal: function() {
          if(!this.user) { this.openAuthModal(); return; }
          document.getElementById('modal-create-pl').style.display = 'flex';
          document.getElementById('new-pl-name').focus();
      },
      
      savePlaylist: function() {
          const name = document.getElementById('new-pl-name').value;
          if(!name) return;
          if(name.length > 50) { this.showToast("Nome muito longo (máx 50)", "error"); return; }
          this.state.playlists.push({ name: name, songs: [], isEditable: true }); 
          this.saveUserData();
          this.closeModals();
          this.renderSidebarPlaylists();
          if(window.innerWidth < 768) this.switchView('library');
          else this.openPlaylistView('custom', this.state.playlists.length - 1);
          this.showToast("Playlist criada!", "success");
      },

      openImportModal: function() {
          if(!this.user) { this.openAuthModal(); return; }
          document.getElementById('modal-import-pl').style.display = 'flex';
          document.getElementById('import-pl-url').focus();
      },
      
      importPlaylistFromUrl: async function() {
          const url = document.getElementById('import-pl-url').value;
          if(!url) return;
          if(!navigator.onLine) { this.showToast("Sem conexão.", "offline"); return; }
          
          let listId = null;
          try {
              if (url.includes('list=')) {
                  const urlObj = new URL(url);
                  listId = urlObj.searchParams.get("list");
              } else {
                  listId = url; 
              }
          } catch(e) {
              listId = url;
          }

          if(!listId) {
              this.showToast("Link inválido.", "error");
              return;
          }
          
          this.showToast("Importando...", "success");
          
          try {
              let tracks = [];
              // Importação real via API na hora do import
              const res = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${listId}&key=${YT_API_KEY}`);
              if(!res.ok) throw new Error("404");
              const json = await res.json();
              
              tracks = json.items.map(item => ({
                  videoId: item.snippet.resourceId.videoId,
                  title: item.snippet.title,
                  author: item.snippet.videoOwnerChannelTitle,
                  thumbnail: item.snippet.thumbnails.default?.url || item.snippet.thumbnails.medium?.url,
                  duration: "3:00"
              }));

              if(tracks && tracks.length > 0) {
                  const mappedTracks = tracks.map(v => ({
                      id: v.videoId || v.id, videoId: v.videoId || v.id,
                      title: v.title, artist: v.author || v.artist,
                      thumb: v.thumbnail || v.thumb, time: v.duration
                  }));
                  
                  this.state.playlists.push({
                      name: "Playlist Importada", 
                      songs: mappedTracks,
                      thumb: mappedTracks[0].thumb,
                      isEditable: false
                  });
                  this.saveUserData();
                  this.closeModals();
                  this.renderSidebarPlaylists();
                  this.showToast("Playlist importada com sucesso!", "success");
              } else {
                   this.showToast("Não foi possível carregar as músicas.", "error");
              }
          } catch(e) {
              console.log(e);
              this.showToast("Erro ao importar. Verifique o ID/Privacidade.", "error");
          }
      },

      openEditPlaylistModal: function() {
          if(this.currentPlaylistIndex === null) return;
          const pl = this.state.playlists[this.currentPlaylistIndex];
          
          if(pl.isEditable === false) {
              this.showToast("Esta playlist não pode ser editada.", "error");
              return;
          }

          document.getElementById('edit-pl-name').value = pl.name;
          const prev = document.getElementById('edit-pl-img-prev');
          const icon = document.getElementById('edit-pl-icon-prev');
          
          if(pl.thumb) {
              prev.src = pl.thumb;
              prev.style.display = 'block';
              icon.style.display = 'none';
          } else {
              prev.src = "";
              prev.style.display = 'none';
              icon.style.display = 'flex';
          }
          document.getElementById('edit-pl-file').value = ""; 
          document.getElementById('modal-edit-pl').style.display = 'flex';
      },
      
      uploadImageToImgBB: async function(file) {
          if(!navigator.onLine) { this.showToast("Sem conexão.", "offline"); return null; }
          const formData = new FormData();
          formData.append('image', file);
          try {
              this.showToast("Enviando imagem...", "success");
              const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
                  method: 'POST',
                  body: formData
              });
              const data = await res.json();
              if(data.success) return data.data.url;
              else throw new Error("Falha no upload");
          } catch(e) {
              this.showToast("Erro ao enviar imagem", "error");
              return null;
          }
      },

      confirmEditPlaylist: async function() {
          if(this.currentPlaylistIndex === null) return;
          const newName = document.getElementById('edit-pl-name').value;
          const fileInput = document.getElementById('edit-pl-file');
          
          if(newName) {
              if(newName.length > 50) { this.showToast("Nome muito longo", "error"); return; }
              this.state.playlists[this.currentPlaylistIndex].name = newName;
              if(fileInput.files.length > 0) {
                  const url = await this.uploadImageToImgBB(fileInput.files[0]);
                  if(url) this.state.playlists[this.currentPlaylistIndex].thumb = url;
              }
              this.saveUserData();
              this.renderSidebarPlaylists();
              this.openPlaylistView('custom', this.currentPlaylistIndex);
              this.closeModals();
              this.showToast("Playlist atualizada.", "success");
          }
      },
      
      removePlaylistCover: function() {
           if(this.currentPlaylistIndex === null) return;
           if(this.state.playlists[this.currentPlaylistIndex].thumb) {
               delete this.state.playlists[this.currentPlaylistIndex].thumb;
               document.getElementById('edit-pl-img-prev').style.display = 'none';
               document.getElementById('edit-pl-icon-prev').style.display = 'flex';
           }
      },

      deletePlaylist: function() {
          if(this.currentPlaylistIndex === null) return;
          if(confirm("Tem certeza que deseja apagar esta playlist?")) {
              this.state.playlists.splice(this.currentPlaylistIndex, 1);
              this.saveUserData();
              this.renderSidebarPlaylists();
              this.switchView('home');
              this.closeModals();
              this.showToast("Playlist apagada.", "success");
          }
      },

      toggleLike: function(e) {
         if(e) e.stopPropagation();
         if(!this.user) { this.openAuthModal(); return; }
         if(this.currentTrack) this.handleLike(this.currentTrack);
      },
      
      handleLike: function(track) {
         const idx = this.state.likes.findIndex(x => x.id === track.id);
         if(idx > -1) {
             this.state.likes.splice(idx, 1);
             this.showToast("Removido das músicas curtidas", "success");
         } else {
             this.state.likes.push(track);
             this.showToast("Adicionado às músicas curtidas", "success");
         }
         this.saveUserData();
         this.updateLikeBtns(track.id);
         this.renderSidebarPlaylists();
      },
      
      removeFromCurrentPlaylist: function() {
          if(!this.user || this.currentPlaylistIndex === null || !this.state.ctxTrack) return;
          
          if(this.state.playlists[this.currentPlaylistIndex].isEditable === false) {
              this.showToast("Não é possível remover músicas desta playlist.", "error");
              this.closeCtx();
              return;
          }

          const pl = this.state.playlists[this.currentPlaylistIndex];
          const trackIdx = pl.songs.findIndex(s => s.id === this.state.ctxTrack.id);
          if(trackIdx > -1) {
              pl.songs.splice(trackIdx, 1);
              this.saveUserData();
              this.openPlaylistView('custom', this.currentPlaylistIndex);
              this.renderSidebarPlaylists();
              this.showToast("Removida da playlist", "success");
          }
          this.closeCtx();
      },

      // SLEEP TIMER
      setSleepTimer: function(minutes) {
          clearTimeout(this.sleepTimer);
          if(minutes === 0) {
              this.showToast("Sleep timer cancelado", "success");
              return;
          }
          this.showToast(`Música para em ${minutes} minutos`, "success");
          this.sleepTimer = setTimeout(() => {
              if(!this.player.paused) this.togglePlay();
          }, minutes * 60 * 1000);
          this.closeCtx();
      },

      openCtxMenu: function(e, trackId) {
         e.stopPropagation(); 
         e.preventDefault();
         if(!this.user) { this.openAuthModal(); return; }

         let t = null;
         if(trackId) {
             t = MOCK_DATA.find(x => x.id === trackId) || this.state.likes.find(x => x.id === trackId);
             if(!t && this.state.playlists.length > 0) {
                 for(let p of this.state.playlists) {
                     let found = p.songs.find(s => s.id === trackId);
                     if(found) { t = found; break; }
                 }
             }
             if(!t && this.history.length > 0) t = this.history.find(x => x.id === trackId);
             if(!t && this.playlist.length > 0) t = this.playlist.find(x => (x.videoId === trackId || x.id === trackId));
             if(!t) t = { id: trackId }; 
         } else {
             t = this.currentTrack;
         }
         
         if(!t) return;
         this.state.ctxTrack = t;
         
         const isLiked = this.state.likes.some(x => x.id === t.id);
         const likeText = isLiked ? "Descurtir" : "Curtir";
         const likeIcon = isLiked ? "fa-solid fa-heart-crack" : "fa-regular fa-heart";

         let plHtml = `<div class="ctx-item" onclick="app.addToPlaylistCtx()"><i class="fa-solid fa-plus"></i> Adicionar à Playlist</div>`;
         let queueHtml = `<div class="ctx-item" onclick="app.addToQueue(app.state.ctxTrack); app.closeCtx();"><i class="fa-solid fa-list-ul"></i> Adicionar à Fila</div>`;
         
         if(this.currentPlaylistIndex !== null && document.getElementById('view-playlist').classList.contains('active')) {
             if(this.state.playlists[this.currentPlaylistIndex].isEditable !== false) {
                 plHtml = `<div class="ctx-item" onclick="app.removeFromCurrentPlaylist()"><i class="fa-solid fa-minus"></i> Remover desta Playlist</div>`;
             }
         }

         let timerHtml = "";
         if(!trackId && this.currentTrack) {
             // Se for clicado sem trackId (menu do player)
             queueHtml = "";
             timerHtml = `
                <div style="height:1px; background:#3e3e3e; margin:4px 0;"></div>
                <div class="ctx-item" style="cursor:default; opacity:0.6; font-size:12px;">SLEEP TIMER</div>
                <div class="ctx-item" onclick="app.setSleepTimer(15)">Em 15 minutos</div>
                <div class="ctx-item" onclick="app.setSleepTimer(30)">Em 30 minutos</div>
                <div class="ctx-item" onclick="app.setSleepTimer(0)">Cancelar Timer</div>
             `;
         }

         const menu = document.getElementById('ctx-menu');
         menu.innerHTML = `
            <div class="ctx-item" onclick="app.toggleLikeFromCtx()"><i class="${likeIcon}"></i> ${likeText}</div>
            ${queueHtml}
            ${plHtml}
            ${timerHtml}
            <div class="ctx-item" onclick="app.closeCtx()"><i class="fa-solid fa-xmark"></i> Fechar</div>
         `;
         this.positionCtxMenu(e, menu);
      },

      openPlaylistHeaderMenu: function(e) {
          e.stopPropagation();
          if(!this.user) { this.openAuthModal(); return; }
          if(this.currentPlaylistIndex === null) return; 

          const pl = this.state.playlists[this.currentPlaylistIndex];
          let menuItems = "";

          if(pl.isEditable !== false) {
              menuItems += `<div class="ctx-item" onclick="app.openEditPlaylistModal(); app.closeCtx();"><i class="fa-solid fa-pen"></i> Editar Playlist</div>`;
          }
          
          menuItems += `<div class="ctx-item" onclick="app.deletePlaylist(); app.closeCtx();"><i class="fa-solid fa-trash"></i> Apagar Playlist</div>`;
          
          menuItems += `<div class="ctx-item" onclick="app.closeCtx()"><i class="fa-solid fa-xmark"></i> Fechar</div>`;

          const menu = document.getElementById('ctx-menu');
          menu.innerHTML = menuItems;
          this.positionCtxMenu(e, menu);
      },

      positionCtxMenu: function(e, menu) {
         let x = e.clientX, y = e.clientY;
         
         if(window.innerWidth > 768) {
             if(!x && !y) { x = window.innerWidth/2; y = window.innerHeight/2; }
             if(x + 220 > window.innerWidth) x = window.innerWidth - 230;
             if(y + 160 > window.innerHeight) y = window.innerHeight - 170;
             menu.style.top = y + 'px'; menu.style.left = x + 'px';
         } else {
             menu.style.top = 'auto'; menu.style.left = '0';
         }

         menu.classList.add('active');
         setTimeout(() => document.addEventListener('click', app.closeCtx, {once:true}), 0);
      },

      closeCtx: function() { document.getElementById('ctx-menu').classList.remove('active'); },
      
      // NOVA FUNÇÃO MULTI-SELECT DE PLAYLIST
      addToPlaylistCtx: function() {
         if(!this.user) { this.openAuthModal(); return; }
         if(!this.state.ctxTrack) return;
         
         const modal = document.getElementById('modal-sel-pl');
         const list = document.getElementById('sel-pl-list');
         list.innerHTML = "";
         
         const userPlaylists = this.state.playlists.map((pl, i) => ({...pl, idx: i})).filter(pl => pl.isEditable !== false);

         if(userPlaylists.length === 0) list.innerHTML = "<div style='padding:15px; color:#777;'>Nenhuma playlist editável criada.</div>";
         
         userPlaylists.forEach((pl) => {
             // Verificar se a música já está na playlist
             const isPresent = pl.songs.some(s => s.id === this.state.ctxTrack.id || s.videoId === this.state.ctxTrack.videoId);
             
             const div = document.createElement('div');
             div.className = `playlist-select-item ${isPresent ? 'selected' : ''}`;
             
             let imgHTML = `<div style="width:40px;height:40px;background:#333;display:flex;align-items:center;justify-content:center;border-radius:4px;"><i class="fa-solid fa-music" style="color:#7f7f7f;font-size:14px;"></i></div>`;
             if(pl.thumb) imgHTML = `<img src="${pl.thumb}">`;

             div.innerHTML = `
                ${imgHTML}
                <div class="playlist-select-info">
                   <div class="playlist-select-name">${pl.name}</div>
                   <div class="playlist-select-count">${pl.songs.length} músicas</div>
                </div>
                <div class="playlist-checkbox"></div>
             `;
             
             div.onclick = () => {
                 this.toggleTrackInPlaylist(pl.idx, div);
             };

             list.appendChild(div);
         });
         modal.style.display = 'flex';
      },

      toggleTrackInPlaylist: function(plIndex, divEl) {
          const pl = this.state.playlists[plIndex];
          const track = this.state.ctxTrack;
          
          const trackIdx = pl.songs.findIndex(s => s.id === track.id || s.videoId === track.videoId);
          
          if (trackIdx > -1) {
              // Remover
              pl.songs.splice(trackIdx, 1);
              divEl.classList.remove('selected');
          } else {
              // Adicionar
              pl.songs.push(track);
              divEl.classList.add('selected');
          }
          // Atualiza contagem na UI
          divEl.querySelector('.playlist-select-count').textContent = `${pl.songs.length} músicas`;
      },

      closeModalsAndSave: function() {
          this.closeModals();
          this.saveUserData();
          this.renderSidebarPlaylists();
          // Se estiver vendo a playlist que foi modificada, atualiza
          if (document.getElementById('view-playlist').classList.contains('active') && this.currentPlaylistIndex !== null) {
              this.openPlaylistView('custom', this.currentPlaylistIndex);
          }
          this.showToast("Playlists atualizadas", "success");
      },

      toggleLikeFromCtx: function() {
          if(!this.user) { this.openAuthModal(); return; }
          if(this.state.ctxTrack) this.handleLike(this.state.ctxTrack);
          this.closeCtx();
      },

      closeModals: function() {
         document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
         document.getElementById('new-pl-name').value = "";
         document.getElementById('import-pl-url').value = "";
      },
      
      handlePlayerBarClick: function(e) {
          if(e.target.closest('.controls') || e.target.closest('.player-right') || e.target.closest('input') || e.target.closest('#mini-like-btn')) return;
          if(window.innerWidth < 768) this.openFullPlayer();
      },
      openFullPlayer: function() { document.getElementById('full-player').classList.add('open'); },
      closeFullPlayer: function() { document.getElementById('full-player').classList.remove('open'); },

      showToast: function(msg, type) {
          const container = document.getElementById('toast-container');
          const div = document.createElement('div');
          div.className = `toast ${type}`;
          div.textContent = msg;
          container.appendChild(div);
          setTimeout(() => div.classList.add('show'), 100);
          setTimeout(() => {
              div.classList.remove('show');
              setTimeout(() => div.remove(), 300);
          }, 4000);
      },

      setupEventListeners: function() {
         let timer;
         document.getElementById('search-input').addEventListener('input', (e) => {
             clearTimeout(timer);
             if(e.target.value.length === 0) this.renderSearchHistory();
             else timer = setTimeout(() => this.doSearch(e.target.value), 300);
         });
         
         document.getElementById('search-input').addEventListener('keypress', (e) => {
             if(e.key === "Enter") this.doSearch(e.target.value);
         });
         
         ['seek-bar', 'fp-seek-bar'].forEach(id => {
             const el = document.getElementById(id);
             el.addEventListener('change', (e) => {
                 if (this.castSession) {
                     const time = (e.target.value / 100) * (this.remotePlayer.duration || 1);
                     this.remotePlayer.currentTime = time;
                     this.remotePlayerController.seek();
                 } else if(this.player.duration) {
                     this.player.currentTime = (e.target.value / 100) * this.player.duration;
                 }
             });
             el.addEventListener('input', (e) => {
                 this.updateSliderBg(id, e.target.value);
             });
         });

         const volBar = document.getElementById('vol-bar');
         volBar.addEventListener('input', (e) => {
             this.setVolume(e.target.value);
         });

         document.getElementById('desk-player-dots').onclick = (e) => this.openCtxMenu(e);
         document.getElementById('fp-dots').onclick = (e) => this.openCtxMenu(e);
      },

      saveExternalPlaylist: async function(items, title, thumb) {
          if(!this.user) { this.openAuthModal(); return; }
          if(!items || items.length === 0) return;
          
          this.state.playlists.push({ 
              name: title || "Playlist Importada", 
              songs: items, 
              thumb: thumb,
              isEditable: false 
          });
          this.saveUserData();
          this.renderSidebarPlaylists();
          const btn = document.getElementById('pl-action-btn');
          if(btn) {
              btn.className = "fa-solid fa-heart";
              btn.style.color = "#1ed760";
          }
          this.showToast("Playlist salva na biblioteca!", "success");
      },

      getRandomColor: function() {
         const c = ['#532652', '#0f3657', '#5e4e09', '#084f33', '#721818', '#383838', '#1a2e5c'];
         return c[Math.floor(Math.random() * c.length)];
      }
    };

    window.app = app;
    app.init();

  </script>
</body>
</html>