<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Exlify</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="logo.png">
</head>
<body>

  <div id="toast-container"></div>

  <div id="main-wrapper">
    <nav id="sidebar">
       <div class="sidebar-block" style="margin-bottom: 8px;">
         <div class="logo">
             <img src="logo.png" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fa-solid fa-music\' style=\'font-size:32px;margin-right:8px;\'></i> Exlify'"> 
             Exlify
         </div>
         <div class="nav-btn active" onclick="app.switchView('home')"><i class="fa-solid fa-house"></i> Início</div>
         <div class="nav-btn" onclick="app.switchView('search')"><i class="fa-solid fa-magnifying-glass"></i> Buscar</div>
       </div>

       <div class="sidebar-block" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
         <div class="library-header">
            <span><i class="fa-solid fa-book" style="margin-right: 0;"></i> Sua Biblioteca</span>
            <i class="fa-solid fa-plus pointer" onclick="app.openCreatePlaylistModal()" title="Criar Playlist"></i>
         </div>
         
         <div class="library-scroll" id="playlist-list">
         </div>
       </div>
    </nav>

    <main id="content">
      
      <div class="top-bar">
          <div class="top-bar-nav">
              <button class="back-btn disabled" id="main-back-btn" onclick="app.goBack()"><i class="fa-solid fa-chevron-left"></i></button>
          </div>

          <div id="login-btn-header" class="login-btn-white" onclick="app.openAuthModal()">Entrar</div>
          
          <div id="user-profile-header" class="user-pill hidden" onclick="app.toggleUserMenu(event)">
             <div class="user-avatar"><i class="fa-regular fa-user"></i></div>
             <span id="header-username">Usuário</span>
             <i class="fa-solid fa-caret-down" style="font-size: 12px;"></i>
             
             <div id="user-menu" class="user-menu-dropdown">
                 <div class="um-item" onclick="app.openEditProfile()"><i class="fa-solid fa-pen"></i> Editar Perfil</div>
                 <div style="height:1px; background:#3e3e3e; margin:4px 0;"></div>
                 <div class="um-item" onclick="app.doLogout()"><i class="fa-solid fa-arrow-right-from-bracket"></i> Sair</div>
             </div>
          </div>
      </div>

      <div id="view-home" class="view active">
        <div id="login-cta" class="login-cta hidden">
            <div>
               <h3>Entre para ouvir suas músicas</h3>
               <p>Salve playlists, curta faixas e sincronize seus dados.</p>
            </div>
            <button class="login-btn-white" onclick="app.openAuthModal()">Entrar de graça</button>
        </div>

        <h2 id="greeting-msg">Olá</h2>
        
        <h3 style="margin-top: 30px;">Navegar por todas as seções</h3>
        <div id="genre-container" class="genre-grid"></div>

        <h3>Tocadas Recentemente</h3>
        <div class="grid" id="home-grid"></div>
      </div>

      <div id="view-search" class="view">
        <div class="search-header">
          <div class="search-bar">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input type="text" id="search-input" placeholder="O que você quer ouvir?">
          </div>
        </div>
        <div id="search-history-container" style="display:none; margin-bottom: 20px;">
           <h3>Buscas Recentes</h3>
           <div id="search-history-list" class="grid" style="grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));"></div>
        </div>
        <h3 id="search-res-title">Resultados</h3>
        <div id="search-results" style="display:flex; flex-direction:column; gap:2px;">
           <div style="text-align:center; color:#777; margin-top:40px;">
             Busque por músicas ou artistas.
           </div>
        </div>
      </div>

      <div id="view-playlist" class="view">
         <div id="pl-header-bg" class="pl-header">
            <div id="pl-cover" class="pl-cover-large">
               <i class="fa-solid fa-music"></i>
            </div>
            <div class="pl-details">
              <div class="pl-type">Playlist</div>
              <h1 id="pl-title" class="pl-name">Nome da Playlist</h1>
              <div class="pl-meta">
                 <span id="pl-owner">Exlify User</span> • <span id="pl-count">0 músicas</span>
                 <i id="btn-edit-pl" class="fa-solid fa-pencil pointer" style="margin-left: 10px; font-size: 14px; opacity: 0.6;" onclick="app.openEditPlaylistModal()"></i>
              </div>
            </div>
         </div>
         
         <div style="padding: 24px 0; display: flex; align-items: center; gap: 32px;">
             <div class="play-icon" style="width: 56px; height: 56px; background: var(--sp-green); border-radius: 50%; box-shadow: 0 8px 8px rgba(0,0,0,0.3);" onclick="app.playPlaylistContext()">
                 <i class="fa-solid fa-play" style="margin-left: 4px; font-size: 24px;"></i>
             </div>
             <i id="pl-action-btn" class="fa-solid fa-ellipsis" style="font-size: 28px; color: #b3b3b3; cursor: pointer;" onclick="app.openPlaylistHeaderMenu(event)"></i>
         </div>

         <div style="display: grid; grid-template-columns: 40px 50px 1fr 40px 60px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 16px; color: #b3b3b3; font-size: 12px; text-transform: uppercase; margin-right: -16px; margin-left: -16px; padding-left: 16px; padding-right: 16px;">
             <div style="text-align: center;">#</div>
             <div></div>
             <div>Título</div>
             <div></div>
             <div style="text-align: center;"><i class="fa-regular fa-clock"></i></div>
         </div>
         
         <div id="pl-tracks-container"></div>
      </div>

      <div id="view-library" class="view">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
              <h2>Sua Biblioteca</h2>
              <i class="fa-solid fa-plus pointer" style="font-size:24px;" onclick="app.openCreatePlaylistModal()"></i>
          </div>
          <div id="mobile-lib-list"></div>
      </div>

    </main>
  </div>

  <footer id="player-bar" onclick="app.handlePlayerBarClick(event)">
    <div class="player-left">
      <img id="mini-thumb" src="https://i.ytimg.com/vi/m7Bc3pLyjk0/mqdefault.jpg" loading="lazy">
      <div class="current-info">
        <h4 id="mini-title">Exlify</h4>
        <p id="mini-artist">Escolha uma música</p>
      </div>
      <i class="fa-regular fa-heart" id="mini-like-btn" style="margin-left:15px; color:#b3b3b3; cursor: pointer;" onclick="app.toggleLike(event)"></i>
    </div>

    <div class="player-center">
      <div class="controls">
        <i class="fa-solid fa-shuffle" id="btn-shuffle" onclick="app.toggleShuffle()" title="Aleatório"></i>
        <i class="fa-solid fa-backward-step" onclick="app.prevTrack(event)" title="Voltar"></i>
        <div class="play-icon" id="main-play-btn-wrapper" onclick="app.togglePlay(event)">
           <i class="fa-solid fa-play" id="main-play-icon" style="margin-left:2px;"></i>
        </div>
        <i class="fa-solid fa-forward-step" onclick="app.nextTrack(event)" title="Avançar"></i>
        <i class="fa-solid fa-repeat" id="btn-repeat" onclick="app.toggleRepeat()" title="Repetir"></i>
      </div>
      
      <div class="progress-container" onclick="event.stopPropagation()">
        <span id="curr-time">0:00</span>
        <input type="range" id="seek-bar" class="sp-range" value="0" min="0" max="100" step="0.1">
        <span id="tot-time">0:00</span>
      </div>
    </div>

    <div class="player-right">
       <i class="fa-solid fa-ellipsis" id="desk-player-dots" title="Mais opções"></i>
       <div class="vol-wrapper">
           <i class="fa-solid fa-volume-high" id="vol-icon" style="margin-right:8px;"></i>
           <input type="range" id="vol-bar" class="sp-range" style="width:80px;" value="100" min="0" max="100" oninput="app.setVolume(this.value)">
       </div>
    </div>
    
    <i class="fa-solid fa-play mobile-mini-play" id="mobile-mini-icon" onclick="app.togglePlay(event)"></i>
  </footer>

  <nav id="mobile-nav">
    <div class="mobile-item active" onclick="app.switchView('home')"><i class="fa-solid fa-house"></i> Início</div>
    <div class="mobile-item" onclick="app.switchView('search')"><i class="fa-solid fa-magnifying-glass"></i> Buscar</div>
    <div class="mobile-item" onclick="app.switchView('library')"><i class="fa-solid fa-book"></i> Biblioteca</div>
  </nav>

  <div id="full-player">
     <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px; color:#fff;">
        <i class="fa-solid fa-chevron-down" style="font-size:24px; cursor:pointer;" onclick="app.closeFullPlayer()"></i>
        <span style="font-size:12px; font-weight:700; letter-spacing:1px;">TOCANDO AGORA</span>
        <i class="fa-solid fa-ellipsis" id="fp-dots" style="font-size:24px; cursor: pointer;"></i>
     </div>
     
     <div style="flex:1; display:flex; align-items:center; justify-content:center; width:100%;">
        <img id="fp-art" class="fp-art" src="" loading="lazy">
     </div>
     
     <div style="margin-bottom:30px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
           <div style="overflow:hidden; padding-right:10px;">
              <h2 id="fp-title" class="text-truncate" style="color:#fff; margin-bottom:5px; font-size: 22px;">Título</h2>
              <p id="fp-artist" class="text-truncate" style="color:#b3b3b3; font-size: 16px;">Artista</p>
           </div>
           <i class="fa-regular fa-heart" id="fp-like-btn" style="font-size:28px; color:#1ed760;" onclick="app.toggleLike()"></i>
        </div>
     </div>

     <div class="fp-controls">
        <div class="progress-container">
           <span id="fp-curr-time">0:00</span>
           <input type="range" id="fp-seek-bar" class="sp-range" value="0" min="0" max="100">
           <span id="fp-tot-time">0:00</span>
        </div>
        
        <div class="fp-main-btns">
           <i class="fa-solid fa-shuffle" id="fp-btn-shuffle" style="font-size:24px; color:#b3b3b3;" onclick="app.toggleShuffle()"></i>
           <i class="fa-solid fa-backward-step" style="font-size:36px; color:#fff;" onclick="app.prevTrack()"></i>
           <div class="fp-play" id="fp-play-btn-wrapper" onclick="app.togglePlay()">
              <i class="fa-solid fa-play" id="fp-play-icon" style="font-size:32px; margin-left:4px;"></i>
           </div>
           <i class="fa-solid fa-forward-step" style="font-size:36px; color:#fff;" onclick="app.nextTrack()"></i>
           <i class="fa-solid fa-repeat" id="fp-btn-repeat" style="font-size:24px; color:#b3b3b3;" onclick="app.toggleRepeat()"></i>
        </div>
     </div>
  </div>

  <div id="modal-auth" class="modal-overlay">
      <div class="modal-box">
          <img src="logo.png" style="width: 80px; margin-bottom: 20px;" onerror="this.style.display='none'">
          <h2 id="auth-title">Entrar no Exlify</h2>
          
          <div id="form-login">
              <input type="email" id="login-email" class="sp-input" placeholder="Email">
              <input type="password" id="login-pass" class="sp-input" placeholder="Senha">
              <button class="sp-btn sp-btn-primary" onclick="app.loginEmail()">Entrar</button>
              <button class="sp-btn sp-btn-google" onclick="app.loginGoogle()"><i class="fa-brands fa-google"></i> Continuar com Google</button>
              <div class="modal-link" onclick="app.toggleAuthMode()">Não tem conta? Inscreva-se</div>
          </div>

          <div id="form-register" class="hidden">
              <input type="text" id="reg-name" class="sp-input" placeholder="Como devemos chamar você?">
              <input type="email" id="reg-email" class="sp-input" placeholder="Email">
              <input type="password" id="reg-pass" class="sp-input" placeholder="Crie uma senha">
              <button class="sp-btn sp-btn-primary" onclick="app.registerEmail()">Inscrever-se</button>
              <div class="modal-link" onclick="app.toggleAuthMode()">Já tem conta? Faça login</div>
          </div>
          
          <button class="sp-btn sp-btn-sec" style="margin-top:20px; font-size:12px;" onclick="app.closeModals()">Fechar</button>
      </div>
  </div>

  <div id="modal-profile" class="modal-overlay">
      <div class="modal-box">
          <h3>Editar Perfil</h3>
          <input type="text" id="edit-profile-name" class="sp-input" placeholder="Novo nome de usuário">
          <div style="display:flex; justify-content:flex-end; gap:10px;">
              <button class="sp-btn sp-btn-sec" onclick="app.closeModals()">Cancelar</button>
              <button class="sp-btn sp-btn-primary" onclick="app.saveProfile()">Salvar</button>
          </div>
      </div>
  </div>

  <div id="modal-create-pl" class="modal-overlay">
     <div class="modal-box">
        <h3>Criar Playlist</h3>
        <input type="text" id="new-pl-name" class="sp-input" placeholder="Minha Playlist #1">
        <div style="display:flex; justify-content:flex-end; gap: 10px;">
           <button class="sp-btn sp-btn-sec" onclick="app.closeModals()">Cancelar</button>
           <button class="sp-btn sp-btn-primary" onclick="app.savePlaylist()">CRIAR</button>
        </div>
     </div>
  </div>

  <div id="modal-edit-pl" class="modal-overlay">
     <div class="modal-box">
        <h3>Editar Detalhes</h3>
        <div class="edit-grid">
            <div class="edit-cover-wrapper" onclick="document.getElementById('edit-pl-file').click()">
                <img id="edit-pl-img-prev" src="" style="display:none; object-fit:cover; width:100%; height:100%;">
                <div id="edit-pl-icon-prev" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#333;">
                    <i class="fa-solid fa-music" style="font-size:48px; color:#7f7f7f;"></i>
                </div>
                <div class="edit-overlay">
                    <i class="fa-solid fa-pen"></i>
                    <span>Escolher foto</span>
                </div>
                <input type="file" id="edit-pl-file" accept="image/*" style="display:none;">
            </div>
            <div class="edit-inputs">
                <input type="text" id="edit-pl-name" class="sp-input" placeholder="Nome da Playlist" style="margin-top:0;">
                <input type="text" class="sp-input" placeholder="Descrição (Opcional)" disabled style="cursor:not-allowed; opacity:0.6;">
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; width:100%;">
           <div style="display:flex; gap:10px;">
               <button class="sp-btn sp-btn-danger" style="padding:12px 20px; font-size:12px;" onclick="app.deletePlaylist()">Apagar</button>
               <button class="sp-btn sp-btn-sec" style="padding:12px 20px; font-size:12px;" onclick="app.removePlaylistCover()">Remover Foto</button>
           </div>
           <div>
               <button class="sp-btn sp-btn-sec" onclick="app.closeModals()">Cancelar</button>
               <button class="sp-btn sp-btn-primary" onclick="app.confirmEditPlaylist()">SALVAR</button>
           </div>
        </div>
     </div>
  </div>

  <div id="modal-sel-pl" class="modal-overlay">
     <div class="modal-box">
       <h3>Adicionar à Playlist</h3>
       <div id="sel-pl-list" style="max-height:240px; overflow-y:auto; text-align:left; margin:20px 0; border: 1px solid #333; border-radius: 4px;"></div>
       <button class="sp-btn sp-btn-sec" onclick="app.closeModals()">Fechar</button>
     </div>
  </div>

  <div id="ctx-menu" class="context-menu"></div>

  <audio id="main-audio" style="display:none;" crossorigin="anonymous"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCCfscTwkS20CYqwIj0DRdT4dUIdYwv5cM",
      authDomain: "spotfeike.firebaseapp.com",
      projectId: "spotfeike",
      storageBucket: "spotfeike.firebasestorage.app",
      messagingSenderId: "275170038515",
      appId: "1:275170038515:web:57c9f5dc22e79a0ff65d86",
      measurementId: "G-PMYLBS84C3"
    };

    const fbApp = initializeApp(firebaseConfig);
    const auth = getAuth(fbApp);
    const db = getFirestore(fbApp);
    const provider = new GoogleAuthProvider();

    const GENRES = [
      { name: "Pop", color: "#8d67ab", icon: "fa-music" },
      { name: "Rock", color: "#e91429", icon: "fa-guitar" },
      { name: "Hip-Hop", color: "#ba5d07", icon: "fa-microphone-lines" },
      { name: "Eletrônica", color: "#006450", icon: "fa-bolt" },
      { name: "Funk", color: "#e61e32", icon: "fa-drum" },
      { name: "Sertanejo", color: "#bc5900", icon: "fa-hat-cowboy" },
      { name: "Relax", color: "#477d95", icon: "fa-spa" },
      { name: "Treino", color: "#777777", icon: "fa-dumbbell" }
    ];

    const MOCK_DATA = [
      { id: 'm7Bc3pLyjk0', title: 'Sweater Weather', artist: 'The Neighbourhood', thumb: 'https://i.ytimg.com/vi/m7Bc3pLyjk0/mqdefault.jpg', time: '4:00' },
      { id: '0KSOMA3QBU0', title: 'Dark Horse', artist: 'Katy Perry', thumb: 'https://i.ytimg.com/vi/0KSOMA3QBU0/mqdefault.jpg', time: '3:35' },
      { id: 'lp-EO5I60KA', title: 'Thinking Out Loud', artist: 'Ed Sheeran', thumb: 'https://i.ytimg.com/vi/lp-EO5I60KA/mqdefault.jpg', time: '4:41' },
      { id: 'fJ9rUzIMcZQ', title: 'Bohemian Rhapsody', artist: 'Queen', thumb: 'https://i.ytimg.com/vi/fJ9rUzIMcZQ/mqdefault.jpg', time: '5:55' },
      { id: 'RgKAFK5djSk', title: 'See You Again', artist: 'Wiz Khalifa', thumb: 'https://i.ytimg.com/vi/RgKAFK5djSk/mqdefault.jpg', time: '3:49' },
      { id: 'kJQP7kiw5Fk', title: 'Despacito', artist: 'Luis Fonsi', thumb: 'https://i.ytimg.com/vi/kJQP7kiw5Fk/mqdefault.jpg', time: '3:48' },
      { id: 'nfWlot6h_JM', title: 'Shake It Off', artist: 'Taylor Swift', thumb: 'https://i.ytimg.com/vi/nfWlot6h_JM/mqdefault.jpg', time: '3:39' },
      { id: 'hT_nvWreIhg', title: 'Counting Stars', artist: 'OneRepublic', thumb: 'https://i.ytimg.com/vi/hT_nvWreIhg/mqdefault.jpg', time: '4:17' }
    ];

    const IMGBB_KEY = "753a069314b2b06edaef1e8bcd5fc9ea";

    // --- NOVA LÓGICA DO APP (SIMPLIFICADA) ---
    const app = {
      player: null,
      playlist: [],
      currentIndex: 0,
      
      user: null,
      isShuffle: false,
      repeatMode: 0, 
      
      state: {
        playlists: [],
        likes: [],
        lastPlayed: null, 
        ctxTrack: null
      },
      
      history: [],
      tempPlaylistObj: null,
      viewStack: [],
      isBackNav: false,

      init: function() {
        this.player = document.getElementById('main-audio');
        
        // Registrar Service Worker se disponível (da sua lógica nova)
        if('serviceWorker' in navigator){
           navigator.serviceWorker.register('/service-worker.js').catch(e => console.log("SW Error:", e));
        }

        this.setupPlayerEvents();
        this.loadHistory();
        this.renderHome();
        this.setupEventListeners();

        onAuthStateChanged(auth, async (user) => {
            this.user = user;
            if (user) {
                document.getElementById('login-cta').classList.add('hidden');
                document.getElementById('login-btn-header').classList.add('hidden');
                document.getElementById('user-profile-header').classList.remove('hidden');
                document.getElementById('header-username').textContent = user.displayName || "Usuário";
                await this.loadUserData(user.uid);
            } else {
                this.state.playlists = [];
                this.state.likes = [];
                document.getElementById('login-cta').classList.remove('hidden');
                document.getElementById('login-btn-header').classList.remove('hidden');
                document.getElementById('user-profile-header').classList.add('hidden');
                this.renderSidebarPlaylists();
            }
        });

        document.getElementById('edit-pl-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('edit-pl-img-prev').src = e.target.result;
                    document.getElementById('edit-pl-img-prev').style.display = 'block';
                    document.getElementById('edit-pl-icon-prev').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('content').addEventListener('scroll', function() {
            const topBar = document.querySelector('.top-bar');
            if(this.scrollTop > 50) topBar.classList.add('scrolled');
            else topBar.classList.remove('scrolled');
        });
      },
      
      loadHistory: function() {
          const h = localStorage.getItem('exli_history');
          if(h) { try { this.history = JSON.parse(h); } catch(e) { this.history = []; } }
      },
      
      addToHistory: function(track) {
          this.history = this.history.filter(t => t.id !== track.id);
          this.history.unshift(track);
          if(this.history.length > 10) this.history = this.history.slice(0, 10);
          localStorage.setItem('exli_history', JSON.stringify(this.history));
          if(document.getElementById('view-search').classList.contains('active')) this.renderSearchHistory();
      },

      loadUserData: async function(uid) {
         try {
             const docRef = doc(db, "users", uid);
             const docSnap = await getDoc(docRef);
             if(docSnap.exists()) {
                 const data = docSnap.data();
                 this.state.playlists = data.playlists || [];
                 this.state.likes = data.likes || [];
             } else {
                 await setDoc(docRef, { playlists: [], likes: [], lastPlayed: null });
             }
             this.renderSidebarPlaylists();
         } catch(e) { console.error("Error loading data", e); }
      },

      saveUserData: async function() {
          if(!this.user) return;
          try {
              await setDoc(doc(db, "users", this.user.uid), {
                  playlists: this.state.playlists,
                  likes: this.state.likes,
                  lastPlayed: this.state.lastPlayed
              }, { merge: true });
          } catch(e) { console.error("Error saving data", e); }
      },

      openAuthModal: function() {
          document.getElementById('modal-auth').style.display = 'flex';
          document.getElementById('form-login').classList.remove('hidden');
          document.getElementById('form-register').classList.add('hidden');
          document.getElementById('auth-title').innerText = "Entrar no Exlify";
      },
      
      toggleAuthMode: function() {
          const login = document.getElementById('form-login');
          const reg = document.getElementById('form-register');
          const title = document.getElementById('auth-title');
          if(login.classList.contains('hidden')) {
              login.classList.remove('hidden');
              reg.classList.add('hidden');
              title.innerText = "Entrar no Exlify";
          } else {
              login.classList.add('hidden');
              reg.classList.remove('hidden');
              title.innerText = "Inscrever-se grátis";
          }
      },

      loginEmail: async function() {
          const email = document.getElementById('login-email').value;
          const pass = document.getElementById('login-pass').value;
          try {
              await signInWithEmailAndPassword(auth, email, pass);
              this.closeModals();
              this.showToast("Login realizado com sucesso!", "success");
          } catch(e) { this.showToast("Erro: " + e.message, "error"); }
      },

      registerEmail: async function() {
          const email = document.getElementById('reg-email').value;
          const pass = document.getElementById('reg-pass').value;
          const name = document.getElementById('reg-name').value;
          try {
              const cred = await createUserWithEmailAndPassword(auth, email, pass);
              await updateProfile(cred.user, { displayName: name });
              this.closeModals();
              this.showToast("Conta criada! Bem-vindo(a).", "success");
              window.location.reload(); 
          } catch(e) { this.showToast("Erro: " + e.message, "error"); }
      },

      loginGoogle: async function() {
          try {
              await signInWithPopup(auth, provider);
              this.closeModals();
              this.showToast("Logado com Google!", "success");
          } catch(e) { this.showToast("Erro: " + e.message, "error"); }
      },

      toggleUserMenu: function(e) {
          e.stopPropagation();
          const menu = document.getElementById('user-menu');
          menu.classList.toggle('active');
          if(menu.classList.contains('active')) {
              document.addEventListener('click', () => menu.classList.remove('active'), {once:true});
          }
      },

      openEditProfile: function() {
          if(!this.user) return;
          document.getElementById('edit-profile-name').value = this.user.displayName;
          document.getElementById('modal-profile').style.display = 'flex';
      },

      saveProfile: async function() {
          const newName = document.getElementById('edit-profile-name').value;
          if(newName && this.user) {
              await updateProfile(this.user, { displayName: newName });
              document.getElementById('header-username').textContent = newName;
              this.closeModals();
              this.showToast("Perfil atualizado!", "success");
          }
      },

      doLogout: async function() {
          await signOut(auth);
          this.showToast("Você saiu da conta.", "success");
          this.renderHome();
      },

      // --- PLAYER LOGIC (SUBSTITUÍDA PELA SUA NOVA LÓGICA) ---
      
playAudio: function(video) {
   // Atualiza UI do Exlify
   this.currentTrack = video; 
   this.addToHistory(video);
   this.updatePlayerUI(video);
   this.updateTrackHighlight();
   this.updatePlayIcons(true); // Força ícone de pause

   // Lógica do seu código novo
   const vId = video.videoId || video.id;
   this.player.src = `/api/audio?v=${vId}`;
   this.player.play().catch(e => console.error(e));
   
   this.setBuffering(true); // Assume buffering ao iniciar

   // ===== Pré-carregamento do próximo vídeo =====
   const nextIndex = this.currentIndex + 1; // Certifique que currentIndex está definido
   if (this.playlist && nextIndex < this.playlist.length) {
       const nextVideo = this.playlist[nextIndex];
       const tmpAudio = new Audio(`/api/audio?v=${nextVideo.videoId || nextVideo.id}`);
       tmpAudio.preload = "auto";
   }

   // Media Session
   if('mediaSession' in navigator){
      navigator.mediaSession.metadata = new MediaMetadata({
          title: video.title,
          artist: video.artist || video.author,
          artwork: [
              { src: video.thumb, sizes: "96x96", type: "image/jpeg" },
              { src: video.thumb, sizes: "128x128", type: "image/jpeg" },
              { src: video.thumb, sizes: "192x192", type: "image/jpeg" },
              { src: video.thumb, sizes: "256x256", type: "image/jpeg" },
              { src: video.thumb, sizes: "384x384", type: "image/jpeg" },
              { src: video.thumb, sizes: "512x512", type: "image/jpeg" },
          ]
      });

      navigator.mediaSession.setActionHandler('play', ()=>this.togglePlay());
      navigator.mediaSession.setActionHandler('pause', ()=>this.togglePlay());
      navigator.mediaSession.setActionHandler('seekbackward', ()=> { this.player.currentTime -= 10; });
      navigator.mediaSession.setActionHandler('seekforward', ()=> { this.player.currentTime += 10; });
      navigator.mediaSession.setActionHandler('previoustrack', ()=>this.prevTrack());
      navigator.mediaSession.setActionHandler('nexttrack', ()=>this.nextTrack());
   }
},

      setupPlayerEvents: function() {
         // Evento Ended (da sua lógica)
         this.player.addEventListener('ended', () => {
             if(this.currentIndex < this.playlist.length - 1) {
                 this.playAudio(this.playlist[++this.currentIndex]);
             } else if (this.repeatMode === 1) {
                 this.currentIndex = 0;
                 this.playAudio(this.playlist[0]);
             }
         });
         
         // Buffering events
         this.player.addEventListener('waiting', () => { this.setBuffering(true); });
         this.player.addEventListener('playing', () => { this.setBuffering(false); });
         this.player.addEventListener('canplay', () => { this.setBuffering(false); });

         // Eventos para atualizar a UI do Exlify (Barras de progresso)
         this.player.addEventListener('timeupdate', () => {
             if(!this.player.duration) return;
             const cur = this.player.currentTime;
             const dur = this.player.duration;
             const pct = (cur / dur) * 100;
             
             // Atualiza sliders do Exlify
             ['seek-bar', 'fp-seek-bar'].forEach(id => {
                 const el = document.getElementById(id);
                 if(el && document.activeElement !== el) { // Não atualiza se o usuário estiver arrastando
                     el.value = pct;
                     el.style.setProperty('--progress-percent', `${pct}%`);
                 }
             });
             
             document.getElementById('curr-time').textContent = this.fmtTime(cur);
             document.getElementById('tot-time').textContent = this.fmtTime(dur);
             document.getElementById('fp-curr-time').textContent = this.fmtTime(cur);
             document.getElementById('fp-tot-time').textContent = this.fmtTime(dur);
         });

         this.player.addEventListener('play', () => this.updatePlayIcons(true));
         this.player.addEventListener('pause', () => this.updatePlayIcons(false));
      },
      
      setBuffering: function(isBuffering) {
          const els = [
              document.getElementById('main-play-btn-wrapper'),
              document.getElementById('fp-play-btn-wrapper'),
              document.getElementById('mobile-mini-icon')
          ];
          
          els.forEach(el => {
              if(!el) return;
              if(isBuffering) el.classList.add('buffering');
              else el.classList.remove('buffering');
          });
      },

      playContext: function(trackList, startIndex) {
         this.playlist = trackList;
         this.currentIndex = startIndex;
         this.playAudio(trackList[startIndex]);
      },
      
      playPlaylistContext: function() {
          let tracks = [];
          if(this.tempPlaylistObj && document.getElementById('view-playlist').classList.contains('active') && this.currentPlaylistIndex === null && document.getElementById('pl-title').textContent === this.tempPlaylistObj.title) {
              tracks = this.tempPlaylistObj.songs;
          } else if(this.currentPlaylistIndex === null) {
              tracks = this.state.likes;
          } else if(this.state.playlists[this.currentPlaylistIndex]) {
              tracks = this.state.playlists[this.currentPlaylistIndex].songs;
          }
          if(tracks.length > 0) this.playContext(tracks, 0);
      },

      nextTrack: function(e) {
          if(e) e.stopPropagation();
          if(this.playlist.length === 0) return;
          
          if(this.isShuffle) {
              this.currentIndex = Math.floor(Math.random() * this.playlist.length);
              this.playAudio(this.playlist[this.currentIndex]);
          } else if(this.currentIndex < this.playlist.length - 1) {
              this.playAudio(this.playlist[++this.currentIndex]);
          } else if (this.repeatMode === 1) {
              this.currentIndex = 0;
              this.playAudio(this.playlist[0]);
          }
      },

      prevTrack: function(e) {
          if(e) e.stopPropagation();
          if(this.playlist.length === 0) return;
          
          if(this.player.currentTime > 3) {
             this.player.currentTime = 0;
             return;
          }

          if(this.currentIndex > 0) {
              this.playAudio(this.playlist[--this.currentIndex]);
          } else {
              this.playAudio(this.playlist[0]);
          }
      },

      togglePlay: function(e) {
        if(e) e.stopPropagation();
        if(this.player.paused) this.player.play();
        else this.player.pause();
      },

      updatePlayIcons: function(isPlaying) {
        const icons = ['main-play-icon', 'mobile-mini-icon', 'fp-play-icon'];
        icons.forEach(id => {
          const el = document.getElementById(id);
          if(!el) return;
          el.className = isPlaying ? "fa-solid fa-pause" : "fa-solid fa-play";
          el.style.marginLeft = isPlaying ? "0" : "2px"; 
        });
      },

      // --- BUSCA NOVA (SIMPLIFICADA) ---
      doSearch: async function(query) {
         if(!query) return;
         const container = document.getElementById('search-results');
         document.getElementById('search-history-container').style.display = 'none';
         document.getElementById('search-res-title').style.display = 'block';
         container.style.display = 'flex';
         container.innerHTML = '<div class="loader-container"><div class="loader"></div></div>';
         
         try {
            // Fetch da sua nova lógica
            const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
            const data = await res.json();

            if(!data.length) {
                 container.innerHTML = '<div style="padding:20px;text-align:center;">Nenhum resultado.</div>';
                 return;
             }
             
             // Mapeia para o visual do Exlify
             const mappedResults = data.map(video => ({
                 id: video.videoId, // Mapeia videoId para id para compatibilidade interna
                 videoId: video.videoId,
                 title: video.title,
                 artist: video.author,
                 thumb: video.thumb || video.thumbnail,
                 time: video.duration || "VIDEO"
             }));

             container.innerHTML = "";
             mappedResults.forEach((t, i) => {
                 const div = document.createElement('div');
                 div.className = "track-list-item";
                 div.innerHTML = `
                   <div style="text-align:center;"><i class="fa-solid fa-music"></i></div>
                   <div style="display:none;"></div>
                   <img src="${t.thumb}" loading="lazy">
                   <div class="meta">
                     <div class="track-title">${t.title}</div>
                     <div class="track-artist">${t.artist}</div>
                   </div>
                   <div style="text-align:right;">
                        <i class="fa-solid fa-ellipsis" onclick="event.stopPropagation(); app.openCtxMenu(event, '${t.id}')"></i>
                   </div>
                   <div></div>
                 `;
                 div.onclick = () => {
                     // Atualiza a playlist global com os resultados da busca
                     this.playContext(mappedResults, i);
                 }
                 container.appendChild(div);
             });

         } catch(e) {
             console.error(e);
             container.innerHTML = '<div style="padding:20px;text-align:center;color:#e91429;">Erro na busca.</div>';
         }
      },

      // --- AUXILIARES ---
      
      toggleShuffle: function() {
          this.isShuffle = !this.isShuffle;
          const color = this.isShuffle ? 'var(--sp-green)' : '#b3b3b3';
          document.getElementById('btn-shuffle').style.color = color;
          document.getElementById('fp-btn-shuffle').style.color = color;
          document.getElementById('btn-shuffle').classList.toggle('active-control', this.isShuffle);
      },

      toggleRepeat: function() {
          this.repeatMode = (this.repeatMode + 1) % 2; // Simplificado para On/Off
          const color = this.repeatMode === 1 ? 'var(--sp-green)' : '#b3b3b3';
          ['btn-repeat', 'fp-btn-repeat'].forEach(id => {
              const el = document.getElementById(id);
              el.style.color = color;
              if(this.repeatMode === 1) el.classList.add('active-control');
              else el.classList.remove('active-control');
          });
      },

      setVolume: function(val) {
          if(this.player) {
              this.player.volume = val / 100;
              const icon = document.getElementById('vol-icon');
              if(val == 0) icon.className = "fa-solid fa-volume-xmark";
              else if(val < 50) icon.className = "fa-solid fa-volume-low";
              else icon.className = "fa-solid fa-volume-high";
              const el = document.getElementById('vol-bar');
              if(el) el.style.setProperty('--progress-percent', `${val}%`);
          }
      },

      fmtTime: function(s) {
        if(!s || isNaN(s)) return "0:00";
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const sc = Math.floor(s % 60);
        if (h > 0) return `${h}:${m < 10 ? '0' + m : m}:${sc < 10 ? '0' + sc : sc}`;
        return `${m}:${sc < 10 ? '0' + sc : sc}`;
      },

      updateSliderBg: function(id, pct) { // Helper mantido para sliders de volume
        const el = document.getElementById(id);
        if(el) el.style.setProperty('--progress-percent', `${pct}%`);
      },

      updatePlayerUI: function(t) {
        document.getElementById('mini-title').textContent = t.title;
        document.getElementById('mini-artist').textContent = t.artist || t.author;
        document.getElementById('mini-thumb').src = t.thumb;
        document.getElementById('fp-title').textContent = t.title;
        document.getElementById('fp-artist').textContent = t.artist || t.author;
        document.getElementById('fp-art').src = t.thumb;
        this.updateLikeBtns(t.id);
        
        // Cores de fundo (Aleatório para manter visual)
        const rndColor = this.getRandomColor();
        document.getElementById('full-player').style.background = `linear-gradient(180deg, ${rndColor} 0%, #121212 100%)`;
      },

      updateLikeBtns: function(id) {
        const isLiked = this.state.likes.some(x => x.id === id);
        const els = [document.getElementById('mini-like-btn'), document.getElementById('fp-like-btn')];
        els.forEach(el => {
           if(isLiked) {
             el.className = "fa-solid fa-heart";
             el.style.color = "#1ed760";
           } else {
             el.className = "fa-regular fa-heart";
             el.style.color = "#b3b3b3";
           }
        });
      },
      
      updateTrackHighlight: function() {
          document.querySelectorAll('.track-title').forEach(el => el.classList.remove('text-green'));
          if(this.currentTrack && document.getElementById('view-playlist').classList.contains('active')) {
              this.openPlaylistView('refresh');
          }
      },

      switchView: function(id) {
        if(!this.isBackNav) {
            const currentActive = document.querySelector('.view.active');
            if(currentActive) {
                const currentId = currentActive.id.replace('view-', '');
                if(currentId !== id) this.viewStack.push(currentId);
            }
        }

        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.mobile-item').forEach(e => e.classList.remove('active'));

        document.getElementById('view-' + id).classList.add('active');

        const backBtn = document.getElementById('main-back-btn');
        if (this.viewStack.length > 0) backBtn.classList.remove('disabled');
        else backBtn.classList.add('disabled');

        if (id === 'home') {
           document.querySelectorAll('.nav-btn')[0].classList.add('active');
           document.querySelectorAll('.mobile-item')[0].classList.add('active');
           this.updateGreeting();
        } else if (id === 'search') {
           document.querySelectorAll('.nav-btn')[1].classList.add('active');
           document.querySelectorAll('.mobile-item')[1].classList.add('active');
           this.renderSearchHistory();
           document.getElementById('search-input').focus();
        } else if (id === 'library') {
           document.querySelectorAll('.mobile-item')[2].classList.add('active');
           this.renderMobileLibrary();
        }
        this.closeFullPlayer();
        document.getElementById('content').scrollTop = 0;
      },
      
      goBack: function() {
         if(this.viewStack.length > 0) {
             this.isBackNav = true;
             const prevView = this.viewStack.pop();
             this.switchView(prevView);
             this.isBackNav = false;
         } else {
             this.switchView('home');
         }
      },
      
      renderSearchHistory: function() {
          const container = document.getElementById('search-history-container');
          const list = document.getElementById('search-history-list');
          const res = document.getElementById('search-results');
          const resTitle = document.getElementById('search-res-title');
          const input = document.getElementById('search-input');
          
          if(input.value.length > 0) {
              container.style.display = 'none';
              res.style.display = 'flex';
              resTitle.style.display = 'block';
              return;
          }

          if(this.history.length > 0) {
              container.style.display = 'block';
              res.style.display = 'none';
              resTitle.style.display = 'none';
              list.innerHTML = "";
              this.history.forEach((t, i) => {
                  const div = document.createElement('div');
                  div.className = "card";
                  div.innerHTML = `
                       <img src="${t.thumb}" loading="lazy">
                       <div class="card-title" style="font-size:14px;">${t.title}</div>
                       <div class="card-desc">${t.artist || t.author}</div>
                  `;
                  div.onclick = () => { this.playContext(this.history, i); };
                  list.appendChild(div);
              });
          } else {
              container.style.display = 'none';
              res.style.display = 'flex';
              resTitle.style.display = 'block';
          }
      },

      updateGreeting: function() {
          const h = new Date().getHours();
          let msg = "Bom dia";
          if(h >= 12 && h < 18) msg = "Boa tarde";
          else if(h >= 18) msg = "Boa noite";
          document.getElementById('greeting-msg').textContent = msg;
      },

      renderHome: function() {
        this.updateGreeting();
        const genreGrid = document.getElementById('genre-container');
        genreGrid.innerHTML = "";
        GENRES.forEach(g => {
            const el = document.createElement('div');
            el.className = "genre-card";
            el.style.backgroundColor = g.color;
            el.innerHTML = `<div class="genre-title">${g.name}</div><div class="genre-img"><i class="fa-solid ${g.icon}"></i></div>`;
            el.onclick = () => {
                this.switchView('search');
                document.getElementById('search-input').value = g.name;
                this.doSearch(g.name);
            };
            genreGrid.appendChild(el);
        });

        const grid = document.getElementById('home-grid');
        grid.innerHTML = "";
        
        const likeCard = document.createElement('div');
        likeCard.className = "card";
        likeCard.innerHTML = `
           <div style="width:100%; aspect-ratio:1; background:linear-gradient(135deg,#450af5,#c4efd9); display:flex; center; justify-content:center; align-items:center; border-radius:4px; margin-bottom:16px;">
               <i class="fa-solid fa-heart" style="font-size:40px; color:#fff;"></i>
           </div>
           <div class="play-btn-hover" onclick="event.stopPropagation(); app.openPlaylistView('likes'); app.playPlaylistContext();">
              <i class="fa-solid fa-play" style="margin-left:2px;"></i>
           </div>
           <div class="card-title">Músicas Curtidas</div>
           <div class="card-desc">Suas músicas favoritas</div>
        `;
        likeCard.onclick = () => this.openPlaylistView('likes');
        grid.appendChild(likeCard);

        MOCK_DATA.forEach(t => grid.appendChild(this.createTrackCard(t)));
      },

      createTrackCard: function(t) {
        const div = document.createElement('div');
        div.className = "card";
        div.innerHTML = `
           <img src="${t.thumb}" loading="lazy">
           <div class="play-btn-hover" onclick="event.stopPropagation(); app.playContext(MOCK_DATA, MOCK_DATA.findIndex(x=>x.id==='${t.id}'))">
              <i class="fa-solid fa-play" style="margin-left:2px;"></i>
           </div>
           <div class="card-title">${t.title}</div>
           <div class="card-desc">${t.artist}</div>
        `;
        div.onclick = () => { this.playContext(MOCK_DATA, MOCK_DATA.findIndex(x=>x.id === t.id)); };
        return div;
      },

      renderSidebarPlaylists: function() {
         const div = document.getElementById('playlist-list');
         div.innerHTML = "";
         
         const likeItem = document.createElement('div');
         likeItem.className = "playlist-item";
         if(document.getElementById('pl-title').textContent === "Músicas Curtidas" && document.getElementById('view-playlist').classList.contains('active')) {
             likeItem.classList.add('active-pl');
         }

         likeItem.innerHTML = `
            <div style="width:48px;height:48px;background:linear-gradient(135deg,#450af5,#c4efd9);display:flex;align-items:center;justify-content:center;border-radius:4px;flex-shrink:0;"><i class="fa-solid fa-heart" style="color:#fff;"></i></div>
            <div class="pl-info-side"><h4>Músicas Curtidas</h4><p>Playlist • ${this.state.likes.length} músicas</p></div>
         `;
         likeItem.onclick = () => this.openPlaylistView('likes');
         div.appendChild(likeItem);

         this.state.playlists.forEach((pl, idx) => {
            const item = document.createElement('div');
            item.className = "playlist-item";
            if(this.currentPlaylistIndex === idx && document.getElementById('view-playlist').classList.contains('active')) {
                item.classList.add('active-pl');
            }
            
            let imgHTML = `<div style="width:48px;height:48px;background:#333;display:flex;align-items:center;justify-content:center;border-radius:4px;flex-shrink:0;"><i class="fa-solid fa-music" style="color:#7f7f7f;"></i></div>`;
            if(pl.thumb) imgHTML = `<img src="${pl.thumb}">`;

            item.innerHTML = `${imgHTML}<div class="pl-info-side"><h4>${pl.name}</h4><p>Playlist • ${pl.songs.length} músicas</p></div>`;
            item.onclick = () => this.openPlaylistView('custom', idx);
            item.oncontextmenu = (e) => {
                e.preventDefault();
                this.currentPlaylistIndex = idx;
                this.openEditPlaylistModal();
            }
            div.appendChild(item);
         });
         
         if(document.getElementById('view-library').classList.contains('active')) this.renderMobileLibrary();
      },

      renderMobileLibrary: function() {
          const list = document.getElementById('mobile-lib-list');
          list.innerHTML = "";
          
          const likeDiv = document.createElement('div');
          likeDiv.className = "mobile-lib-item";
          likeDiv.innerHTML = `
              <div class="mobile-lib-img" style="background:linear-gradient(135deg,#450af5,#c4efd9);"><i class="fa-solid fa-heart" style="color:#fff;"></i></div>
              <div class="mobile-lib-info"><h4>Músicas Curtidas</h4><p>Playlist • ${this.state.likes.length} músicas</p></div>
          `;
          likeDiv.onclick = () => this.openPlaylistView('likes');
          list.appendChild(likeDiv);

          this.state.playlists.forEach((pl, idx) => {
             const div = document.createElement('div');
             div.className = "mobile-lib-item";
             let imgHTML = `<div class="mobile-lib-img"><i class="fa-solid fa-music" style="color:#7f7f7f;"></i></div>`;
             if(pl.thumb) imgHTML = `<div class="mobile-lib-img"><img src="${pl.thumb}"></div>`;

             div.innerHTML = `${imgHTML}<div class="mobile-lib-info"><h4>${pl.name}</h4><p>Playlist • ${pl.songs.length} músicas</p></div>`;
             div.onclick = () => this.openPlaylistView('custom', idx);
             div.oncontextmenu = (e) => {
                e.preventDefault();
                this.currentPlaylistIndex = idx;
                this.openEditPlaylistModal();
             };
             list.appendChild(div);
          });
      },

      openPlaylistView: function(type, idx) {
         if(type === 'refresh') {
             if(this.currentPlaylistIndex === null && document.getElementById('pl-title').textContent === 'Músicas Curtidas') type = 'likes';
             else if(this.currentPlaylistIndex !== null) { type = 'custom'; idx = this.currentPlaylistIndex; }
             else return;
         }

         this.switchView('playlist');
         const container = document.getElementById('pl-tracks-container');
         container.innerHTML = "";
         
         let title = "", tracks = [], grad = "", coverHTML = "";
         const actionBtn = document.getElementById('pl-action-btn');
         
         actionBtn.style.display = 'block';
         actionBtn.className = "fa-solid fa-ellipsis";
         actionBtn.onclick = (e) => app.openPlaylistHeaderMenu(e);

         if(type === 'likes') {
            title = "Músicas Curtidas";
            tracks = this.state.likes;
            grad = "linear-gradient(to bottom, #5038a0, #121212)";
            coverHTML = '<i class="fa-solid fa-heart" style="color:#fff;"></i>';
            document.getElementById('pl-cover').style.background = "linear-gradient(135deg,#450af5,#c4efd9)";
            document.getElementById('pl-cover').innerHTML = coverHTML;
            this.currentPlaylistIndex = null;
            document.getElementById('btn-edit-pl').style.display = 'none';
         } else if (type === 'external') {
            const extPl = this.tempPlaylistObj;
            title = extPl.title;
            tracks = extPl.songs;
            grad = `linear-gradient(to bottom, ${this.getRandomColor()}, #121212)`;
            if(extPl.thumb) {
               coverHTML = `<img src="${extPl.thumb}">`;
               document.getElementById('pl-cover').style.background = "transparent";
            } else {
               coverHTML = '<i class="fa-solid fa-music"></i>';
               document.getElementById('pl-cover').style.background = "#282828";
            }
            document.getElementById('pl-cover').innerHTML = coverHTML;
            this.currentPlaylistIndex = null; 
            document.getElementById('btn-edit-pl').style.display = 'none';
            document.getElementById('pl-owner').textContent = extPl.author;
            actionBtn.className = "fa-regular fa-heart";
            actionBtn.style.color = "#b3b3b3";
            actionBtn.onclick = (e) => { e.stopPropagation(); app.saveExternalPlaylist(tracks, title); };
            
         } else {
            const pl = this.state.playlists[idx];
            title = pl.name;
            tracks = pl.songs;
            grad = `linear-gradient(to bottom, ${this.getRandomColor()}, #121212)`;
            if(pl.thumb) {
                coverHTML = `<img src="${pl.thumb}">`;
                document.getElementById('pl-cover').style.background = "transparent";
            } else {
                coverHTML = '<i class="fa-solid fa-music"></i>';
                document.getElementById('pl-cover').style.background = "#282828";
            }
            document.getElementById('pl-cover').innerHTML = coverHTML;
            this.currentPlaylistIndex = idx;
            document.getElementById('btn-edit-pl').style.display = 'inline-block';
            document.getElementById('pl-owner').textContent = this.user ? this.user.displayName : "Usuário";
         }

         document.getElementById('pl-title').textContent = title;
         document.getElementById('pl-count').textContent = tracks.length + " músicas";
         document.getElementById('pl-header-bg').style.background = grad;
         
         this.renderSidebarPlaylists(); 

         if(tracks.length === 0) {
            container.innerHTML = `<div style="padding:40px; text-align:center; color:#777;">Essa playlist está vazia.</div>`;
         } else {
             tracks.forEach((t, i) => {
                const div = document.createElement('div');
                div.className = "track-list-item";
                let titleClass = "track-title";
                let numContent = i+1;
                let isActive = false;
                
                // Comparação robusta (videoId ou id)
                const currentId = this.currentTrack ? (this.currentTrack.videoId || this.currentTrack.id) : null;
                const itemId = t.videoId || t.id;

                if(currentId && currentId === itemId) {
                    titleClass += " text-green";
                    // numContent = '<img src="https://open.spotifycdn.com/cdn/images/equaliser-animated-green.f93a2ef4.gif" style="width:14px;height:14px;border-radius:0;">'; 
                    // REMOVIDO A ANIMAÇÃO GIF, MANTENDO APENAS O NÚMERO (E A COR VERDE VIA CLASSE)
                    numContent = `<span class="text-green">${i+1}</span>`;
                    isActive = true;
                }

                div.innerHTML = `
                  <div style="text-align:center;" class="track-num">${numContent}</div>
                  <div class="track-play-icon" style="text-align:center; ${isActive ? 'display:block;' : ''}"><i class="fa-solid fa-play"></i></div>
                  <img src="${t.thumb}" loading="lazy">
                  <div class="meta">
                    <div class="${titleClass}">${t.title}</div>
                    <div class="track-artist">${t.artist || t.author}</div>
                  </div>
                  <div style="text-align:right;">
                     <i class="fa-regular fa-heart hidden" style="font-size:14px; margin-right:10px;"></i> 
                     <i class="fa-solid fa-ellipsis" style="font-size:14px; padding: 8px;" onclick="event.stopPropagation(); app.openCtxMenu(event, '${itemId}')"></i>
                  </div>
                  <div style="text-align:center; font-size:12px;">${t.time || "3:00"}</div>
                `;
                div.onclick = () => this.playContext(tracks, i);
                div.oncontextmenu = (e) => { e.preventDefault(); app.openCtxMenu(e, itemId); };
                container.appendChild(div);
             });
         }
      },

      openCreatePlaylistModal: function() {
          if(!this.user) { this.openAuthModal(); return; }
          document.getElementById('modal-create-pl').style.display = 'flex';
          document.getElementById('new-pl-name').focus();
      },
      
      savePlaylist: function() {
          const name = document.getElementById('new-pl-name').value;
          if(!name) return;
          this.state.playlists.push({ name: name, songs: [] });
          this.saveUserData();
          this.closeModals();
          this.renderSidebarPlaylists();
          if(window.innerWidth < 768) this.switchView('library');
          else this.openPlaylistView('custom', this.state.playlists.length - 1);
          this.showToast("Playlist criada!", "success");
      },

      openEditPlaylistModal: function() {
          if(this.currentPlaylistIndex === null) return;
          const pl = this.state.playlists[this.currentPlaylistIndex];
          document.getElementById('edit-pl-name').value = pl.name;
          const prev = document.getElementById('edit-pl-img-prev');
          const icon = document.getElementById('edit-pl-icon-prev');
          
          if(pl.thumb) {
              prev.src = pl.thumb;
              prev.style.display = 'block';
              icon.style.display = 'none';
          } else {
              prev.src = "";
              prev.style.display = 'none';
              icon.style.display = 'flex';
          }
          document.getElementById('edit-pl-file').value = ""; 
          document.getElementById('modal-edit-pl').style.display = 'flex';
      },
      
      uploadImageToImgBB: async function(file) {
          const formData = new FormData();
          formData.append('image', file);
          try {
              this.showToast("Enviando imagem...", "success");
              const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
                  method: 'POST',
                  body: formData
              });
              const data = await res.json();
              if(data.success) return data.data.url;
              else throw new Error("Falha no upload");
          } catch(e) {
              this.showToast("Erro ao enviar imagem", "error");
              return null;
          }
      },

      confirmEditPlaylist: async function() {
          if(this.currentPlaylistIndex === null) return;
          const newName = document.getElementById('edit-pl-name').value;
          const fileInput = document.getElementById('edit-pl-file');
          
          if(newName) {
              this.state.playlists[this.currentPlaylistIndex].name = newName;
              if(fileInput.files.length > 0) {
                  const url = await this.uploadImageToImgBB(fileInput.files[0]);
                  if(url) this.state.playlists[this.currentPlaylistIndex].thumb = url;
              }
              this.saveUserData();
              this.renderSidebarPlaylists();
              this.openPlaylistView('custom', this.currentPlaylistIndex);
              this.closeModals();
              this.showToast("Playlist atualizada.", "success");
          }
      },
      
      removePlaylistCover: function() {
           if(this.currentPlaylistIndex === null) return;
           if(this.state.playlists[this.currentPlaylistIndex].thumb) {
               delete this.state.playlists[this.currentPlaylistIndex].thumb;
               document.getElementById('edit-pl-img-prev').style.display = 'none';
               document.getElementById('edit-pl-icon-prev').style.display = 'flex';
           }
      },

      deletePlaylist: function() {
          if(this.currentPlaylistIndex === null) return;
          if(confirm("Tem certeza que deseja apagar esta playlist?")) {
              this.state.playlists.splice(this.currentPlaylistIndex, 1);
              this.saveUserData();
              this.renderSidebarPlaylists();
              this.switchView('home');
              this.closeModals();
              this.showToast("Playlist apagada.", "success");
          }
      },

      toggleLike: function(e) {
         if(e) e.stopPropagation();
         if(!this.user) { this.openAuthModal(); return; }
         if(this.currentTrack) this.handleLike(this.currentTrack);
      },
      
      handleLike: function(track) {
         const idx = this.state.likes.findIndex(x => x.id === track.id);
         if(idx > -1) {
             this.state.likes.splice(idx, 1);
             this.showToast("Removido das músicas curtidas", "success");
         } else {
             this.state.likes.push(track);
             this.showToast("Adicionado às músicas curtidas", "success");
         }
         this.saveUserData();
         this.updateLikeBtns(track.id);
         this.renderSidebarPlaylists();
      },
      
      removeFromCurrentPlaylist: function() {
          if(!this.user || this.currentPlaylistIndex === null || !this.state.ctxTrack) return;
          const pl = this.state.playlists[this.currentPlaylistIndex];
          const trackIdx = pl.songs.findIndex(s => s.id === this.state.ctxTrack.id);
          if(trackIdx > -1) {
              pl.songs.splice(trackIdx, 1);
              this.saveUserData();
              this.openPlaylistView('custom', this.currentPlaylistIndex);
              this.renderSidebarPlaylists();
              this.showToast("Removida da playlist", "success");
          }
          this.closeCtx();
      },

      openCtxMenu: function(e, trackId) {
         e.stopPropagation(); 
         e.preventDefault();
         if(!this.user) { this.openAuthModal(); return; }

         let t = null;
         if(trackId) {
             t = MOCK_DATA.find(x => x.id === trackId) || this.state.likes.find(x => x.id === trackId);
             if(!t && this.state.playlists.length > 0) {
                 for(let p of this.state.playlists) {
                     let found = p.songs.find(s => s.id === trackId);
                     if(found) { t = found; break; }
                 }
             }
             if(!t && this.history.length > 0) t = this.history.find(x => x.id === trackId);
             if(!t && this.playlist.length > 0) t = this.playlist.find(x => (x.videoId === trackId || x.id === trackId));
             if(!t) t = { id: trackId }; 
         } else {
             t = this.currentTrack;
         }
         
         if(!t) return;
         this.state.ctxTrack = t;
         
         const isLiked = this.state.likes.some(x => x.id === t.id);
         const likeText = isLiked ? "Descurtir" : "Curtir";
         const likeIcon = isLiked ? "fa-solid fa-heart-crack" : "fa-regular fa-heart";

         let plHtml = `<div class="ctx-item" onclick="app.addToPlaylistCtx()"><i class="fa-solid fa-plus"></i> Adicionar à Playlist</div>`;
         
         if(this.currentPlaylistIndex !== null && document.getElementById('view-playlist').classList.contains('active')) {
             plHtml = `<div class="ctx-item" onclick="app.removeFromCurrentPlaylist()"><i class="fa-solid fa-minus"></i> Remover desta Playlist</div>`;
         }

         const menu = document.getElementById('ctx-menu');
         menu.innerHTML = `
            <div class="ctx-item" onclick="app.toggleLikeFromCtx()"><i class="${likeIcon}"></i> ${likeText}</div>
            ${plHtml}
            <div class="ctx-item" onclick="app.closeCtx()"><i class="fa-solid fa-xmark"></i> Fechar</div>
         `;
         this.positionCtxMenu(e, menu);
      },

      openPlaylistHeaderMenu: function(e) {
          e.stopPropagation();
          if(!this.user) { this.openAuthModal(); return; }
          if(this.currentPlaylistIndex === null) return; 

          const menu = document.getElementById('ctx-menu');
          menu.innerHTML = `
             <div class="ctx-item" onclick="app.openEditPlaylistModal(); app.closeCtx();"><i class="fa-solid fa-pen"></i> Editar Playlist</div>
             <div class="ctx-item" onclick="app.deletePlaylist(); app.closeCtx();"><i class="fa-solid fa-trash"></i> Apagar Playlist</div>
             <div class="ctx-item" onclick="app.closeCtx()"><i class="fa-solid fa-xmark"></i> Fechar</div>
          `;
          this.positionCtxMenu(e, menu);
      },

      positionCtxMenu: function(e, menu) {
         let x = e.clientX, y = e.clientY;
         
         // Lógica mobile bottom sheet (não precisa calcular X/Y se for mobile via CSS)
         if(window.innerWidth > 768) {
             if(!x && !y) { x = window.innerWidth/2; y = window.innerHeight/2; }
             if(x + 220 > window.innerWidth) x = window.innerWidth - 230;
             if(y + 160 > window.innerHeight) y = window.innerHeight - 170;
             menu.style.top = y + 'px'; menu.style.left = x + 'px';
         } else {
             // Reset inline styles for mobile bottom sheet to work
             menu.style.top = 'auto'; menu.style.left = '0';
         }

         menu.classList.add('active');
         setTimeout(() => document.addEventListener('click', app.closeCtx, {once:true}), 0);
      },

      closeCtx: function() { document.getElementById('ctx-menu').classList.remove('active'); },
      
      addToPlaylistCtx: function() {
         if(!this.user) { this.openAuthModal(); return; }
         if(!this.state.ctxTrack) return;
         
         const modal = document.getElementById('modal-sel-pl');
         const list = document.getElementById('sel-pl-list');
         list.innerHTML = "";
         
         if(this.state.playlists.length === 0) list.innerHTML = "<div style='padding:15px; color:#777;'>Nenhuma playlist criada.</div>";
         
         this.state.playlists.forEach((pl, idx) => {
             const div = document.createElement('div');
             div.style.padding = "12px"; div.style.borderBottom = "1px solid #333"; div.style.cursor = "pointer";
             div.className = "text-truncate";
             div.textContent = pl.name;
             div.onclick = () => {
                 this.state.playlists[idx].songs.push(this.state.ctxTrack);
                 this.saveUserData();
                 this.renderSidebarPlaylists();
                 this.closeModals();
                 this.showToast(`Adicionado à ${pl.name}`, "success");
             };
             div.onmouseover = () => div.style.background = "#3e3e3e";
             div.onmouseout = () => div.style.background = "transparent";
             list.appendChild(div);
         });
         modal.style.display = 'flex';
      },
      toggleLikeFromCtx: function() {
          if(!this.user) { this.openAuthModal(); return; }
          if(this.state.ctxTrack) this.handleLike(this.state.ctxTrack);
          this.closeCtx();
      },

      closeModals: function() {
         document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
         document.getElementById('new-pl-name').value = "";
      },
      
      handlePlayerBarClick: function(e) {
          if(e.target.closest('.controls') || e.target.closest('.player-right') || e.target.closest('input') || e.target.closest('#mini-like-btn')) return;
          if(window.innerWidth < 768) this.openFullPlayer();
      },
      openFullPlayer: function() { document.getElementById('full-player').classList.add('open'); },
      closeFullPlayer: function() { document.getElementById('full-player').classList.remove('open'); },

      showToast: function(msg, type) {
          const container = document.getElementById('toast-container');
          const div = document.createElement('div');
          div.className = `toast ${type}`;
          div.textContent = msg;
          container.appendChild(div);
          setTimeout(() => div.classList.add('show'), 100);
          setTimeout(() => {
              div.classList.remove('show');
              setTimeout(() => div.remove(), 300);
          }, 3000);
      },

      setupEventListeners: function() {
         let timer;
         document.getElementById('search-input').addEventListener('input', (e) => {
             clearTimeout(timer);
             if(e.target.value.length === 0) this.renderSearchHistory();
             else timer = setTimeout(() => this.doSearch(e.target.value), 300);
         });
         
         document.getElementById('search-input').addEventListener('keypress', (e) => {
             if(e.key === "Enter") this.doSearch(e.target.value);
         });
         
         // Seek simples (atualiza o audioPlayer nativo)
         ['seek-bar', 'fp-seek-bar'].forEach(id => {
             const el = document.getElementById(id);
             el.addEventListener('change', (e) => {
                 if(this.player.duration) {
                     this.player.currentTime = (e.target.value / 100) * this.player.duration;
                 }
             });
             el.addEventListener('input', (e) => {
                 this.updateSliderBg(id, e.target.value);
             });
         });

         const volBar = document.getElementById('vol-bar');
         volBar.addEventListener('input', (e) => {
             this.setVolume(e.target.value);
         });

         document.getElementById('desk-player-dots').onclick = (e) => this.openCtxMenu(e);
         document.getElementById('fp-dots').onclick = (e) => this.openCtxMenu(e);
      },

      saveExternalPlaylist: async function(items, title) {
          if(!this.user) { this.openAuthModal(); return; }
          if(!items || items.length === 0) return;
          
          this.state.playlists.push({ name: title || "Playlist Importada", songs: items });
          this.saveUserData();
          this.renderSidebarPlaylists();
          const btn = document.getElementById('pl-action-btn');
          if(btn) {
              btn.className = "fa-solid fa-heart";
              btn.style.color = "#1ed760";
          }
          this.showToast("Playlist salva na biblioteca!", "success");
      },

      getRandomColor: function() {
         const c = ['#532652', '#0f3657', '#5e4e09', '#084f33', '#721818', '#383838', '#1a2e5c'];
         return c[Math.floor(Math.random() * c.length)];
      }
    };

    window.app = app;
    app.init();

  </script>
</body>

</html>
